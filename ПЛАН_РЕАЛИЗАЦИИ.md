# План реализации ИАС учета технических средств предприятия

## 1. Введение

### 1.1. Назначение документа
Настоящий документ устанавливает план реализации информационно-аналитической системы учета технических средств предприятия (далее — Система) в соответствии с требованиями технического задания (ТЗ), правилами проекта и принятым технологическим стеком.

### 1.2. Технологический стек
Реализация Системы выполняется на следующем технологическом стеке:

- **Серверная часть:** PHP 8.x, фреймворк Yii2.
- **СУБД:** PostgreSQL (версия не ниже 12; целевая схема по DDL `scripts/create_ias_vniic.sql` и документации `docs/bd/МОДЕЛЬ_БД_ias_vniic.md`).
- **Клиентская часть:** веб-интерфейс с поддержкой табличного представления (в т.ч. AG Grid по контракту API при необходимости).

**Примечание.** Реализация выполняется на PHP + Yii2 + PostgreSQL. Перенос на иной технологический стек (в т.ч. Python/Django) не планируется; артефакты, связанные с таким переносом, из контекста проекта выведены.

### 1.3. Связь с артефактами проекта
План опирается на:

- **TZ.md** — функциональные и нефункциональные требования, состав работ (раздел 6), требования к документации и вводу в эксплуатацию;
- **pr.md** — роли системного аналитика, архитектора ИС и подход к проектированию БД/миграции;
- **docs/МОДЕЛЬ_БД_ias_vniic.md**, **docs/ОПИСАНИЕ_И_ПЛАН_ДЕЙСТВИЙ_БД_ias_vniic.md** — целевая модель данных, стратегия миграции и загрузки из Excel;
- **SYSTEM_DESCRIPTION.md** — границы системы, контуры, текущее состояние;
- **карточка актива.md** — учёт карточки актива и карточки пользователя, конфигурация оборудования.

---

## 2. Принципы планирования

### 2.1. Соответствие ТЗ
Этапы плана согласованы с разделом 6 ТЗ (Состав и содержание работ): обследование и уточнение требований → проектирование → разработка → миграция/импорт → испытания → документация и обучение → ввод в эксплуатацию.

### 2.2. Разделение требований и реализации
Требования формулируются в нейтральном виде (как в ТЗ); в плане фиксируются конкретные шаги реализации на выбранном стеке без подмены самих требований.

### 2.3. Управление неопределённостями
Неопределённости, перечисленные в SYSTEM_DESCRIPTION.md (роль «оператор», режим AG Grid, состав контуров, объёмы данных, регламент миграции), закрываются на этапе обследования и фиксируются в проектной документации до начала разработки соответствующих функций.

---

## 3. Этапы реализации

### Этап 1. Обследование объекта автоматизации и уточнение требований

**Цель:** зафиксировать однозначные, проверяемые требования и допущения, необходимые для проектирования и разработки.

| № | Содержание работ | Результат / артефакт |
|---|------------------|----------------------|
| 1.1 | Уточнение ролей и прав доступа (в т.ч. бизнес-смысл роли «оператор») | Описание ролей и матрица доступа, согласованная с Заказчиком |
| 1.2 | Уточнение перечня справочников, обязательных атрибутов заявки и карточки актива | Перечень справочников; список обязательных полей заявки и карточки актива; форматы и диапазоны значений |
| 1.3 | Уточнение перечня отчётов и форматов экспорта | Перечень отчётов, форматы (PDF, HTML, Excel), правила формирования |
| 1.4 | Фиксация регламентов ИБ: политика паролей, блокировка учётной записи, перечень разрешённых типов вложений, ограничения на размер и количество файлов | Регламент безопасности (раздел проектной документации) |
| 1.5 | Определение целевых показателей производительности и объёмов данных (в т.ч. для списков заявок и активов) | Показатели для программы и методики испытаний; при отсутствии — использование значений по умолчанию из п. 5.2 ТЗ |
| 1.6 | Уточнение режима работы табличного представления заявок (клиентская/серверная пагинация и фильтрация) и контракта API для фронтенда | Спецификация контракта API (или подтверждение существующего) |
| 1.7 | Определение источников данных для миграции и правил сопоставления (рабочая БД при наличии, Excel «Основной Учет.xlsx») | Регламент миграции: источники, маппинг полей, критерии успешности |

**Критерий завершения этапа:** утверждённые перечни (роли, справочники, отчёты, регламенты) и зафиксированные допущения; неопределённости из раздела 8.2 SYSTEM_DESCRIPTION сняты в объёме, необходимом для старта этапа 2.

---

### Этап 2. Разработка проектных решений

**Цель:** подготовить логическую архитектуру, модель данных, спецификацию интерфейсов и модель доступа, пригодные для разработки на PHP/Yii2/PostgreSQL.

| № | Содержание работ | Результат / артефакт |
|---|------------------|----------------------|
| 2.1 | Описание логической и компонентной архитектуры Системы (сервер приложений, СУБД, веб-клиент; разделение по контурам: Help Desk, активы, справочники, ПО и лицензии, аудит, отчётность) | Описание архитектуры (документ по разделу 7.1.3 ТЗ) |
| 2.2 | Актуализация логической модели данных по `docs/bd/МОДЕЛЬ_БД_ias_vniic.md` и DDL `scripts/create_ias_vniic.sql`: таблицы, атрибуты, связи, индексы, правила целостности; решение по нормализации связи «заявка — вложение» (таблица связи вместо JSON в `tasks.attachments`) | Логическая модель данных (раздел 7.1.4 ТЗ); при необходимости — скрипт DDL целевой БД |
| 2.3 | Спецификация интерфейсов: перечень эндпоинтов (в т.ч. для AG Grid), форматы запросов/ответов, коды ошибок, правила проверки прав на сервере | Спецификация API (раздел 7.1.6 ТЗ) |
| 2.4 | Модель доступа и аудита: матрица прав по операциям, перечень событий аудита, атрибуты записи аудита (дата/время, пользователь, тип операции, объект, результат, контекст) | Описание ролей и прав доступа (7.1.5); требования к журналу аудита |
| 2.5 | Архитектура безопасности: аутентификация (Yii2 identity, хранение паролей — исключение MD5, переход на bcrypt/argon2), разграничение доступа на сервере, защита вложений и каналов | Раздел архитектуры безопасности в описании архитектуры |

**Критерий завершения этапа:** согласованные описание архитектуры, модель данных, спецификация API и модель доступа; готовность к реализации на этапе 3.

---

### Этап 3. Разработка (создание) Системы

**Цель:** реализовать функциональные контуры Системы в соответствии с ТЗ на базе PHP, Yii2 и PostgreSQL.

Рекомендуемый порядок реализации контуров (с учётом зависимостей):

| Фаза | Контур / направление | Основные требования ТЗ | Ключевые задачи реализации |
|------|----------------------|-------------------------|----------------------------|
| 3.1 | Управление пользователями, ролями и доступом | 5.1.1 | Модели User, Role; RBAC Yii2 (или кастомные правила); аутентификация; блокировка/разблокировка; политика паролей; восстановление доступа с фиксацией в аудите |
| 3.2 | Справочники | 5.1.2 | Ведение справочников (роли, статусы заявок, локации, типы частей/характеристик и т.д.); контроль целостности ссылок; архивирование; история изменений справочников |
| 3.3 | Help Desk (заявки) | 5.1.3 | Модели Task, DicTaskStatus; CRUD заявок; жизненный цикл по статусам; назначение исполнителя; комментарии; видимость по ролям; поиск и фильтрация; история изменений заявки; удаление по регламенту с аудитом |
| 3.4 | Вложения по заявкам | 5.1.4 | Нормализованная связь заявка–вложение (таблица связи при отказе от JSON в `tasks.attachments`); метаданные вложения; загрузка/скачивание/предпросмотр с проверкой прав; ограничения по типам и размеру; запрет inline для SVG/опасных типов; X-Content-Type-Options: nosniff |
| 3.5 | Учёт активов (технические средства) | 5.1.5 | Модели Equipment, EquipHistory, Location; карточка актива (обязательные и дополнительные атрибуты по обследованию); валидация; привязка к локации и пользователю; эксплуатационный статус; полная история жизненного цикла; пакетный ввод/обновление; архивирование |
| 3.6 | Конфигурация оборудования (характеристики) | 5.1.5, карточка актива | Справочники spr_parts, spr_chars; part_char_values по equipment_id; учёт по инв. номеру и конфигурации (см. карточка актива.md) |
| 3.7 | Связь заявок с активами | 5.1.6 | Связь «заявка — актив(ы)» (настройка «один/несколько» по обследованию); отображение связанных заявок в карточке актива |
| 3.8 | Интерфейсы для фронтенда (AG Grid и др.) | 5.1.7 | Эндпоинты данных заявок, смены статуса, назначения исполнителя, комментария; перечень техники пользователя; совместимость с утверждённым контрактом API |
| 3.9 | Поиск, фильтрация, сортировка | 5.1.8 | Поиск активов по инв./серийному номеру, наименованию; фильтрация по локации, закреплению, статусам; поиск/фильтрация по журналу аудита |
| 3.10 | Отчётность и экспорт | 5.1.9 | Отчёты по перечню (заявки, активы); экспорт в PDF, HTML, Excel с учётом прав; статистика по заявкам (пользователи, исполнители, статусы, периоды) |
| 3.11 | Аудит и журналирование | 5.1.10 | Таблица audit_events (или аналог); фиксация операций по п. 5.1.10.1; атрибуты по п. 5.1.10.2; неизменяемость записей журнала |
| 3.12 | Импорт/миграция и начальное наполнение | 5.1.11 | Импорт CSV, JSON, XML, XLSX (UTF-8); пакетная загрузка; протокол импорта (обработано/ошибки); идемпотентность или управляемая повторяемость; валидация форматов и диапазонов |
| 3.13 | Учёт ПО и лицензий | 5.1.12 | Модели Software, License, SoftwareInstall; связи «актив — ПО»; учёт сроков лицензий; уведомления об истечении (способ по обследованию); поиск и фильтрация по ПО и лицензиям |

#### Состояние реализации по контурам (по коду ias_uch_vnii)

*Сводка составлена по просмотру кода в каталоге `ias_uch_vnii/` (модели, контроллеры, миграции, представления).*

| Фаза | Контур | Реализовано | Не реализовано / требует доработки |
|------|--------|-------------|-----------------------------------|
| **3.1** | Пользователи, роли, доступ | Модели `Users`, `Roles` (entities, dictionaries); аутентификация (`LoginForm`, `SiteController::actionLogin`); CRUD пользователей (`UsersController`); разграничение: админ видит список всех, не-админ — только себя (`UsersController::actionIndex`). Проверки роли: `isAdmin()`/`isUser()` по ID 5/4, `isAdministrator()`/`isRegularUser()` по `role_name`. | **ИБ:** `Users::setPassword()` сохраняет MD5 (`models/entities/Users.php:224`); `LoginForm::validatePassword()` сравнивает через MD5 и логирует пароль в `Yii::debug` (`models/forms/LoginForm.php`). Опасные экшены в `UsersController`: `actionResetPassword`, `actionTestPasswords`, `actionIndex2` (доступны любому `@`). Нет разделения прав по операциям в `TasksController` (все действия для любого авторизованного). Восстановление доступа с аудитом не реализовано. |
| **3.2** | Справочники | `DicTaskStatus`, `Roles`, `Location`; миграции для roles, dic_task_status. Локации используются в формах Arm и в выпадающих списках. | Нет CRUD для справочников в отдельном модуле; архивирование и история изменений справочников не реализованы. Перечень по ТЗ не зафиксирован в коде. |
| **3.3** | Help Desk (заявки) | Модели `Tasks`, `DicTaskStatus`; полный CRUD (`TasksController`: index, view, create, update, delete); смена статуса, назначение исполнителя, комментарий через AJAX (`actionChangeStatus`, `actionAssignExecutor`, `actionUpdateComment`). Видимость по ролям в **списке**: админ видит все заявки, пользователь — только свои (`TasksSearch::search()`). Фильтрация по статусу, датам, автору, исполнителю. | **Права:** просмотр/редактирование/удаление одной заявки (`actionView`, `actionUpdate`, `actionDelete`) не проверяют принадлежность заявки текущему пользователю — любой авторизованный может открыть любую заявку по ID. История изменений атрибутов заявки не ведётся. Удаление без регламента и без фиксации в аудите. |
| **3.4** | Вложения | Модель `DeskAttachments`; хранение в `web/uploads/tasks/`. Загрузка при создании/обновлении заявки (`Tasks::uploadFiles()`); данные о связи — **JSON в `tasks.attachments`** (миграция `m251101_000000_fix_tasks_attachments_column` — тип text). Скачивание (`actionDownload`), предпросмотр (`actionPreview`), удаление вложения (`actionDeleteAttachment`). В модели объявлена связь `getTaskAttachments()` через `viaTable('task_attachments')`, но таблица `task_attachments` в миграциях не создаётся; фактическая выборка — по `getAllAttachments()` из JSON. Ограничения: 10 МБ, 10 файлов, расширения в правилах. | **ИБ:** `actionDownload` и `actionPreview` не проверяют, что вложение принадлежит заявке и что у текущего пользователя есть доступ к этой заявке — любой `@` может скачать любое вложение по `id`. В `actionPreview` разрешён **inline для SVG** (риск XSS); заголовок `X-Content-Type-Options: nosniff` не устанавливается. Нормализованная таблица связи заявка–вложение отсутствует. |
| **3.5** | Учёт активов | Модели `Arm`, `Location`; `ArmController`: только **actionIndex** (список с пагинацией) и **actionCreate** (создание с привязкой к пользователю и локации). `ArmSearch` — фильтрация по id_arm, id_user, id_location, name, description, created_at. Связи `getUser()`, `getLocation()`. | Нет **actionView**, **actionUpdate**, **actionDelete** — карточка актива (просмотр/редактирование одной записи) не реализована. Нет модели/таблицы истории (`arm_history`/`equip_history`), эксплуатационного статуса, пакетного ввода, архивирования. |
| **3.6** | Конфигурация оборудования | В модели `Arm` объявлена связь `getPartCharValues()` на класс `PartCharValues` (`models/entities/Arm.php:78–80`). | Класс **PartCharValues** в проекте отсутствует — при обращении к `$arm->partCharValues` возникнет ошибка. Моделей для `spr_parts`, `spr_chars`, `part_char_values` нет; экранов для ведения конфигурации в карточке актива нет. |
| **3.7** | Связь заявок с активами | — | Связь заявка ↔ актив в БД и в коде не реализована. |
| **3.8** | Интерфейсы для фронтенда | `actionGetGridData()` — данные для AG Grid с учётом видимости через `TasksSearch`; пагинация отключена (возврат всех записей). `actionChangeStatus`, `actionAssignExecutor`, `actionUpdateComment` — JSON API. `actionGetUserEquipment($userId)` — список АРМ по `id_user` для detail panel. | **Права:** `actionGetUserEquipment` не проверяет, что текущий пользователь имеет право видеть технику указанного `userId` — возможна утечка данных. Серверная пагинация/фильтрация для AG Grid не реализованы. |
| **3.9** | Поиск, фильтрация | `TasksSearch`: фильтры по id, статусу, автору, исполнителю, датам, тексту. `ArmSearch`: по id_arm, id_user, id_location, name, description. | Поиск/фильтрация по журналу аудита отсутствуют (журнал аудита в приложении не ведётся). |
| **3.10** | Отчётность и экспорт | `actionStatistics()` — страница со статистикой (Highcharts); выборки по пользователям и исполнителям. `actionExportUserStats()` — экспорт в Excel (PhpSpreadsheet). | Перечень отчётов по ТЗ не зафиксирован; экспорт в PDF/HTML не реализован; при экспорте явная проверка прав не выделена. В `getUsersList()` используется `id` при схеме с `id_user` — возможная ошибка при выборе исполнителя. |
| **3.11** | Аудит | — | Журнал аудита в PHP-приложении не ведётся. Таблица `audit_events` в дампе v2 есть, в коде ias_uch_vnii не используется. |
| **3.12** | Импорт/миграция | Миграции Yii2 для users, roles, tasks, dic_task_status, attachments (тип колонки). Скрипты загрузки из Excel — при необходимости в `scripts/` (PHP или утилиты по решению). | Импорт CSV/JSON/XML/XLSX внутри приложения (PHP) не реализован; протокол импорта и идемпотентность не предусмотрены. |
| **3.13** | Учёт ПО и лицензий | — | В коде ias_uch_vnii моделей и экранов для software, licenses, software_installs нет. |

**Итог:** по коду ias_uch_vnii реализованы базово контуры 3.1–3.5 (пользователи, справочники, заявки, вложения, активы — список и создание) и частично 3.8–3.10 (API для AG Grid, поиск, статистика и экспорт в Excel). Контуры 3.6, 3.7, 3.11, 3.12, 3.13 не реализованы. Критичные доработки: хранение паролей (уход от MD5), удаление/ограничение тестовых экшенов, проверка прав при просмотре/редактировании заявки и при скачивании вложений, проверка прав в get-user-equipment, запрет inline для SVG и заголовки безопасности, введение карточки актива (view/update) и при необходимости истории оборудования.

Опционально (по решению Заказчика):

- **3.14** — Мониторинг технического состояния и планирование обслуживания (5.1.13).
- **3.15** — Дашборды и уведомления по событиям (5.1.14).

**Критерий завершения этапа:** реализованы обязательные контуры в соответствии с ТЗ; все операции изменения данных проверяются на права на сервере и при необходимости фиксируются в аудите; устранены выявленные в документации риски (небезопасное хранение паролей, опасные эндпоинты, XSS при предпросмотре).

---

### Источник данных «Основной учёт» и загрузка в БД

Наполнение БД активами и связанными справочниками предполагает загрузку из файла **«Основной Учет.xlsx»** — учёта, ведущегося на предприятии. Учёт этого источника определяет состав полей в схеме, порядок вставки при импорте и логику обработки данных.

#### Что представляет собой «Основной учёт»

| Элемент | Описание |
|--------|-----------|
| **Файл** | `Основной Учет.xlsx` (в корне проекта TZ). |
| **Ядро** | Лист **«АРМ»** — первый лист, диапазон **A1:W792** (23 столбца, 1 строка заголовков + до ~791 строки данных). |
| **Содержимое листа АРМ** | Одна строка = одна учётная единица техники (системный блок, ноутбук, монитор, моноблок, ИБП, коммутатор и т.д.). Столбцы: наименование/тип техники (A), поставщик (B), дата поступления (C), кому поставили (D), дата (E), примечание (F), системный блок (G), ЦП (H), ОЗУ (I), диск/накопители (J), монитор (K), пользователь/ФИО ответственного (L), отдел (M), № монитора (N), № системн. блока (O), инв. номер (P), ОС (Q), IP-адрес (R), имя ПК (S), антивирус (T), помещение (U), доп. поля (V–W). Детальная структура и маппинг — в `docs/СТРУКТУРА_ЛИСТА_АРМ_ОСНОВНОЙ_УЧЕТ.md`. |
| **Неатомарные ячейки** | Во многих ячейках несколько значений через **перенос строки (\n)**, **запятую**, реже « и » или точку с запятой. Типично: Диск (несколько носителей), Монитор (два монитора), ОЗУ (объём + примечание), IP (основной + VPN). При загрузке нужна стратегия: сохранять весь текст в одно поле (description или одна запись в part_char_values) либо разбивать по разделителям и создавать несколько записей в part_char_values (см. п. 3 и 4 того же документа). |
| **Другие листы** | Принтеры; Поставки 2017–2019, 2020, 2021, 2022–1, 2022–2, 2023, 2024, 2025; СБ забрали; Принтеры забрали; Мониторы забрали. В текущем плане первичная загрузка ориентирована на лист **АРМ**; при необходимости учёт принтеров/поставок/выбытия оформляется отдельно (этап обследования). |

#### Влияние на схему БД и приложение

- **Целевая схема (ias_vniic / tech_accounting):** таблица `equipment` содержит отдельные поля: inventory_number, serial_number, equipment_type, status_id, supplier, purchase_date, commissioning_date, warranty_until и т.д., что полностью покрывает данные Основного учёта по листу АРМ (см. `docs/ОСНОВНОЙ_УЧЕТ_И_БД.md`).
- **Рекомендация:** использовать `equipment` с полным набором полей; маппинг столбцов Excel → поля БД выполнять по регламенту и документам модели БД.

#### Порядок вставки при загрузке из листа АРМ

С учётом внешних ключей загрузку выполняют в порядке:

1. **locations** — по столбцу «Помещение»: поиск по `locations.name` или создание записи (location_type «кабинет» или «другое»).
2. **users** — по столбцу «Пользователь» (ФИО): поиск по `users.full_name`; при отсутствии — пропуск строки с записью в протокол или создание пользователя по регламенту (роль по умолчанию, пустой пароль/временный).
3. **equipment**: name — из инв. номера/наименования/№ системн. блока (приоритет по регламенту); responsible_user_id, location_id — из словарей, полученных на шагах 1–2; description — примечание и при необходимости конкатенация части столбцов.
4. **spr_parts**, **spr_chars** — при необходимости заполнить справочники типов частей и характеристик (Процессор, ОЗУ, Жесткий диск, Монитор, ОС, IP, Имя ПК, Антивирус и т.д.).
5. **part_char_values** — по столбцам ЦП, ОЗУ, Диск, Монитор, ОС, IP, Имя, Антивирус: для каждой строки equipment создать записи с соответствующими part_id, char_id, value_text (при неатомарных ячейках — по выбранной стратегии из СТРУКТУРА_ЛИСТА_АРМ).
6. **equip_history** — при наличии в Excel даты поступления/даты: запись с event_type «постановка на учёт», new_value = дата.

Валидация: проверять существование пользователя и локации перед вставкой equipment; при отсутствии — логировать и либо пропускать строку, либо создавать сущность по правилам. Дубликаты: определять уникальность по инв. номеру (или name); при совпадении — обновлять существующую запись или пропускать с записью в протокол (см. `docs/ОСНОВНОЙ_УЧЕТ_И_БД.md`).

#### Существующие артефакты

- **Структура листа и правила:** `docs/СТРУКТУРА_ЛИСТА_АРМ_ОСНОВНОЙ_УЧЕТ.md`, `docs/ОСНОВНОЙ_УЧЕТ_И_БД.md`.
- **Загрузка из листа АРМ:** реализовать в PHP (или скриптами по решению): указать фактические имена столбцов листа АРМ, маппинг под выбранную схему БД (arm или equipment), разбор неатомарных ячеек, валидацию users/locations, обработку дубликатов по инв. номеру, формирование протокола (успешно/ошибки). При наличии скриптов в `scripts/` использовать их как референс или временную утилиту до появления реализации в приложении.

Учёт «Основного учёта» при реализации: решение по расширению схемы под лист АРМ принимается в рамках второй волны (карточка актива и характеристики); реализация или доработка загрузчика и первая загрузка в БД — в третьей волне (импорт) с опорой на перечисленные документы и скрипты.

---

### Рекомендуемый порядок работ (с чего начать)

Ниже предложен практический порядок работ с опорой на текущее состояние кода ias_uch_vnii и план этапов 1–7. Можно начинать с **нулевой волны** (без ожидания полного этапа 1), затем по возможности согласовать минимум требований и продолжать по списку.

#### Нулевая волна: стабилизация и безопасность (1–3 дня)

Цель — устранить критические риски ИБ и убрать опасный код, чтобы система была безопасна для дальнейшей разработки и тестовой эксплуатации.

| № | Работа | Действия |
|---|--------|----------|
| 0.1 | Пароли | В `Users::setPassword()` заменить MD5 на `Yii::$app->security->generatePasswordHash($password)` (bcrypt). В `LoginForm::validatePassword()` вызывать `$user->validatePassword($this->password)` вместо сравнения с `md5($this->password)`; убрать логирование пароля из `Yii::debug`. Сохранить в `Users::validatePassword()` поддержку старого MD5 при первом успешном входе с последующим обновлением хеша (уже есть) — убедиться, что после обновления новый хеш не перезаписывается обратно на MD5. |
| 0.2 | Тестовые/опасные экшены | В `UsersController` удалить или ограничить доступом (например, только для роли с id администратора и проверкой по IP/флагу в config): `actionResetPassword`, `actionTestPasswords`, `actionIndex2`. Либо вынести в отдельный контроллер, отключённый в production. |
| 0.3 | Вложения: проверка прав | В `TasksController::actionDownload` и `actionPreview`: по `attachmentId` найти вложение; определить задачу, в которой оно числится (по полю `tasks.attachments` — JSON с массивом id). Проверить доступ к задаче: текущий пользователь — автор заявки или администратор (или исполнитель — по решению). При отсутствии доступа — 403. |
| 0.4 | Вложения: SVG и заголовки | В `actionPreview`: для расширения `svg` не отдавать файл с `Content-Disposition: inline` (отдавать как скачивание или блокировать предпросмотр). Добавить заголовок `X-Content-Type-Options: nosniff` для всех ответов с файлом. |
| 0.5 | Get-user-equipment | В `actionGetUserEquipment($userId)`: разрешать запрос только если `$userId == Yii::$app->user->id` или текущий пользователь — администратор. Иначе возвращать 403 или пустой массив по политике. |

**Результат нулевой волны:** пароли не в MD5, нет утечки паролей в логах, нет опасных экшенов в общем доступе, скачивание/предпросмотр вложений и данные по технике пользователя защищены проверкой прав.

---

#### Первая волна: права на заявки и задел под аудит (2–4 дня)

| № | Работа | Действия |
|---|--------|----------|
| 1.1 | Права на просмотр/редактирование заявки | Ввести вспомогательный метод в `TasksController` (например, `canUserAccessTask($task)`: автор заявки, исполнитель или администратор). В `actionView`, `actionUpdate`, `actionDelete`, `actionChangeStatus`, `actionAssignExecutor`, `actionUpdateComment`, `actionDeleteAttachment` перед выполнением операции вызывать проверку; при отказе — 403. |
| 1.2 | Исправить getUsersList | В `TasksController::getUsersList()` (и везде, где используется список пользователей для выбора) использовать первичный ключ `users.id`, чтобы выпадающий список исполнителей работал корректно. |
| 1.3 | Задел под аудит | Добавить в БД таблицу `audit_events` (если её ещё нет в текущей схеме) по DDL `scripts/create_ias_vniic.sql`. Создать сервис или хелпер `AuditLog::log($action, $objectType, $objectId, $payload)` с записью в эту таблицу. Пока вызывать логирование только для критичных операций: смена пароля/восстановление доступа, удаление заявки, удаление вложения (достаточно для старта). |

**Результат первой волны:** доступ к заявкам и операциям по ним ограничен автором/исполнителем/админом; список пользователей корректен; есть таблица и задел для журнала аудита.

---

#### Вторая волна: карточка актива, характеристики, история и подготовка схемы под «Основной учёт» (3–5 дней)

| № | Работа | Действия |
|---|--------|----------|
| 2.1 | Карточка актива: просмотр и редактирование | В `ArmController` добавить `actionView($id)`, `actionUpdate($id)`, при необходимости `actionDelete($id)` с проверкой прав (только администратор или ответственный за актив — по решению). Представления: `views/arm/view.php`, доработать форму для `update`. Использовать существующие модели `Arm`, `Location`, `Users`. |
| 2.2 | Модель PartCharValues и совместимость с Arm | Создать модель `PartCharValues` (таблица `part_char_values`, связь с `equipment` по `equipment_id`). При отсутствии таблиц `spr_parts`, `spr_chars`, `part_char_values` в текущей БД — добавить миграции по DDL `scripts/create_ias_vniic.sql`. В форме просмотра/редактирования актива вывести список характеристик (только чтение или простой ввод — по объёму обследования). Убедиться, что связь `Arm::getPartCharValues()` не приводит к ошибке. |
| 2.3 | История оборудования (минимально) | Добавить таблицу `arm_history` (или `equip_history` при едином стиле имён с целевой схемой) и модель `ArmHistory` с полями: equipment_id, changed_by, change_type, old_value, new_value, change_date, comment. При сохранении `Arm` (create/update) записывать одну запись в историю (тип «создание» или «изменение», ключевые поля). В карточке актива вывести список последних записей истории. |
| 2.4 | Схема под загрузку из «Основной Учет.xlsx» | Схема фиксирована: **ias_vniic / tech_accounting** (DDL `scripts/create_ias_vniic.sql`). В модели использовать `equipment` с полями inventory_number, equipment_type, supplier, purchase_date, commissioning_date, status_id и т.д.; маппинг столбцов Excel → поля БД выполнять по регламенту и `docs/ОСНОВНОЙ_УЧЕТ_И_БД.md`. |

**Результат второй волны:** есть полноценная карточка актива (просмотр/редактирование), отображаются характеристики и базовая история; схема БД готова к загрузке данных из листа АРМ файла «Основной Учет.xlsx».

---

#### Третья волна: связь заявка–актив, аудит, импорт из «Основного учёта» (по приоритету)

- **Импорт из «Основной Учет.xlsx» (3.12, приоритет для наполнения БД):**  
  - Доработать скрипт `scripts/load_osnovnoy_uchot.py` (или реализовать загрузчик на PHP: консольная команда Yii2 или отдельный экран для админа) под фактическую структуру листа **АРМ** (имена столбцов по `docs/СТРУКТУРА_ЛИСТА_АРМ_ОСНОВНОЙ_УЧЕТ.md`).  
  - Порядок вставки: locations → users → equipment (arm) → spr_parts/spr_chars при необходимости → part_char_values → arm_history (дата поступления).  
  - Валидация: сопоставление «Помещение» → locations.name (создание при отсутствии), «Пользователь» → users.full_name (пропуск или создание по регламенту); дубликаты по инв. номеру — обновление или пропуск с записью в протокол.  
  - Неатомарные ячейки (Диск, Монитор, ОЗУ, IP): зафиксировать стратегию (одно поле description / одна запись в part_char_values с полным текстом или разбиение по разделителям \n, запятая на несколько записей part_char_values) и реализовать в загрузчике.  
  - Формировать протокол импорта: количество обработанных строк, количество ошибок, список строк с ошибками (номер строки, причина). При необходимости — консольный вывод или выгрузка протокола в файл.  
  - После первой успешной загрузки выполнить контрольную сверку (количество записей в arm/equipment, выборочная проверка по инв. номерам).
- **Связь заявка–актив (3.7):** ввести в БД связь «заявка — актив(ы)» (таблица связи или поле в `tasks`); в форме заявки — выбор одного или нескольких активов; в карточке актива — блок «Связанные заявки».
- **Аудит (3.11):** расширить использование `AuditLog::log` на все операции из п. 5.1.10.1 ТЗ; экран просмотра журнала с фильтрами (по дате, пользователю, типу операции).
- **Импорт CSV/JSON/XML (3.12, общий):** отдельный экран или консольная команда для загрузки CSV/XLSX по регламенту из п. 5.1.11 (универсальный импорт); протокол (успешно/ошибки) и валидация форматов.

Дальнейший порядок — по плану: контур «ПО и лицензии» (3.13), нормализация связи заявка–вложение (таблица `task_attachments` и миграция данных из JSON), серверная пагинация для AG Grid при росте объёма данных.

---

#### Сводка: с чего начать по шагам

1. **Сразу (без ожидания этапа 1):** выполнить **нулевую волну** (пароли, тестовые экшены, проверка прав на вложения и get-user-equipment, SVG и nosniff).
2. **Параллельно или сразу после:** зафиксировать минимум по этапу 1 (роли «администратор»/«пользователь»/«оператор», кто может видеть и менять заявки, кто — активы) в виде короткой матрицы прав в проектной документации.
3. **Далее:** **первая волна** (права на заявки, getUsersList, задел под аудит).
4. **Затем:** **вторая волна** (карточка актива, PartCharValues, arm_history, **решение по схеме под загрузку из «Основной Учет.xlsx»** — п. 2.4).
5. **После этого:** **третья волна** — в приоритете **импорт из «Основной Учет.xlsx»** (лист АРМ): доработать загрузчик, порядок вставки locations → users → equipment → part_char_values → arm_history, валидация и неатомарные ячейки, протокол и сверка. Затем по приоритету: связь заявка–актив, полноценный аудит, универсальный импорт CSV/XLSX.
6. При необходимости — переход к этапу 2 плана (формализация архитектуры и модели данных) для согласования с Заказчиком.

Такой порядок позволяет быстро снизить риски, не блокируя разработку ожиданием полного обследования; учёт источника «Основной учёт» (лист АРМ) заложен в схему на второй волне и в реализацию загрузки на третьей, что обеспечивает наполнение БД реальными данными предприятия после стабилизации ядра.

---

### Этап 4. Подготовка процедур миграции/импорта и начального наполнения данных

**Цель:** обеспечить первичное и повторное наполнение Системы из существующих источников без нарушения целостности данных.

| № | Содержание работ | Результат / артефакт |
|---|------------------|----------------------|
| 4.1 | Скрипты создания и восстановления целевой БД (DDL `scripts/create_ias_vniic.sql`) | Скрипты в каталоге scripts/ (или аналог); при необходимости — миграции Yii2 для схемы |
| 4.2 | Скрипты переноса данных из действующей БД (при наличии) в целевую схему ias_vniic с маппингом полей | SQL или PHP/Yii2-скрипты миграции; регламент запуска |
| 4.3 | Доработка загрузки из Excel «Основной Учет.xlsx»: соответствие структуре листа «АРМ» (docs/СТРУКТУРА_ЛИСТА_АРМ_ОСНОВНОЙ_УЧЕТ.md), валидация ссылок на users/locations, обработка дубликатов и неатомарных ячеек | Обновлённый скрипт load_osnovnoy_uchot.py или аналог на PHP; протокол импорта |
| 4.4 | Контрольные сверки полноты и целостности после миграции | Перечень сверок и критерии успешности (согласованы с Заказчиком) |

**Критерий завершения этапа:** регламент миграции документирован; скрипты выполняются без нарушения целостности; протокол импорта формируется в соответствии с п. 5.1.11.3 ТЗ.

---

### Этап 5. Модульные и интеграционные испытания

**Цель:** проверить работоспособность компонентов и взаимодействие контуров в соответствии с требованиями ТЗ.

| № | Содержание работ | Результат / артефакт |
|---|------------------|----------------------|
| 5.1 | Модульные проверки: аутентификация, RBAC, CRUD заявок и активов, вложения, справочники, аудит, экспорт | Протокол модульных испытаний |
| 5.2 | Интеграционные сценарии: создание заявки с вложением и привязкой к активу; смена статуса и назначение исполнителя; учёт актива с историей и связью с заявками | Протокол интеграционных испытаний |
| 5.3 | Проверка производительности (списки заявок и активов с фильтрами — целевые значения по п. 5.2 ТЗ или программе испытаний) | Результаты замеров; при превышении порогов — мероприятия по оптимизации или регламент длительных операций |
| 5.4 | Проверка безопасности: передача по HTTPS, проверка прав на сервере, отсутствие вывода паролей в логах, защита вложений | Фиксация результатов в протоколе |

**Критерий завершения этапа:** критические несоответствия устранены; результаты зафиксированы в протоколах.

---

### Этап 6. Приёмочные испытания, документация и обучение

**Цель:** подтвердить соответствие Системы ТЗ и обеспечить комплект документации и регламентов для эксплуатации.

| № | Содержание работ | Результат / артефакт |
|---|------------------|----------------------|
| 6.1 | Проведение приёмочных испытаний по программе и методике испытаний | Программа и методика испытаний; акт приёмки / протокол приёмочных испытаний |
| 6.2 | Подготовка руководства пользователя и руководства администратора (запуск, остановка, резервное копирование, восстановление, сопровождение) | Руководство пользователя; руководство администратора (разделы 7.1.7, 7.1.8 ТЗ) |
| 6.3 | Обучение пользователей (при необходимости) | Регламент или материалы обучения |
| 6.4 | Утверждение эксплуатационных регламентов (доступы, резервное копирование, восстановление) | Регламенты по п. 8.1.2 ТЗ |

**Критерий завершения этапа:** приёмочные испытания пройдены; комплект документации по разделу 7 ТЗ подготовлен; регламенты утверждены.

---

### Этап 7. Пилотная эксплуатация и ввод в промышленную эксплуатацию

**Цель:** ввести Систему в эксплуатацию в соответствии с разделом 8 ТЗ.

| № | Содержание работ | Результат / артефакт |
|---|------------------|----------------------|
| 7.1 | Подготовка целевой инфраструктуры (веб-сервер, PHP, PostgreSQL, при необходимости HTTPS) | Параметры инфраструктуры зафиксированы |
| 7.2 | Назначение ответственных за администрирование и сопровождение пользователей | Документальное закрепление |
| 7.3 | Начальное наполнение справочников и выполнение миграции/импорта по регламенту | Выполненная миграция; контрольные сверки пройдены |
| 7.4 | Пилотная эксплуатация (при необходимости) и ввод в промышленную эксплуатацию | Акт ввода в эксплуатацию; система принята по критериям п. 8.4.1 ТЗ |

**Критерий завершения этапа:** система принята к эксплуатации; регламенты резервного копирования и восстановления проверены; модель разграничения доступа и аудит проверены по критичным сценариям.

---

## 4. Сводная последовательность этапов

| Этап | Наименование | Зависимости |
|------|--------------|-------------|
| 1 | Обследование и уточнение требований | — |
| 2 | Проектные решения (архитектура, модель данных, API, безопасность) | Этап 1 |
| 3 | Разработка Системы (контуры 3.1–3.13, при необходимости 3.14–3.15) | Этап 2 |
| 4 | Миграция и импорт данных | Этап 2 (схема БД); этап 3 (модели и импорт) |
| 5 | Модульные и интеграционные испытания | Этап 3 |
| 6 | Приёмочные испытания, документация, обучение | Этапы 3, 4, 5 |
| 7 | Ввод в эксплуатацию | Этап 6 |

---

## 5. Рекомендуемое применение промптов из pr.md

При выполнении работ целесообразно использовать контекст из pr.md следующим образом:

- **Системный аналитик и технический писатель:** при формулировании и актуализации требований, подготовке разделов ТЗ и проектной документации — структура ТЗ, проверяемые формулировки, официально-деловой стиль.
- **Архитектор ИС:** при разработке разделов 2.1, 2.4, 2.5 плана — логическая и компонентная архитектура, архитектура данных и безопасности без привязки к конкретным продуктам в тексте требований; обоснование решений.
- **Задача по проектированию БД:** при этапах 2.2, 4.1–4.3 — использовать DDL `scripts/create_ias_vniic.sql` и документы модели БД; при необходимости — уточнение целевой схемы и стратегии загрузки из Excel по документу `docs/СТРУКТУРА_ЛИСТА_АРМ_ОСНОВНОЙ_УЧЕТ.md`.

---

## 6. Допущения и ограничения плана

6.1. Исходный код существующего приложения (PHP/Yii2) в текущей рабочей папке проекта может отсутствовать; при его наличии загрузка кода позволит уточнить план (повторное использование модулей, рефакторинг, приоритеты доработок).

6.2. Контур «Закупки» в объём реализации по настоящему плану не включается (согласно п. 1.4.6 ТЗ).

6.3. Включение подразделов 5.1.13 (мониторинг и планирование обслуживания) и 5.1.14 (дашборды и уведомления) в объём реализации определяется решением Заказчика и фиксируется в ходе этапа 1.

6.4. Требования к надёжности (резервное копирование, RPO/RTO по п. 5.3 ТЗ) и к безопасности (п. 5.4 ТЗ) выполняются в рамках разработки и документируются в руководстве администратора и регламентах эксплуатации.

---

## 7. Работа на разных ОС (macOS, Windows)

Проект ведётся на машинах с macOS и Windows 10/11. Чтобы не оглядываться на платформу:

**7.1. Окончания строк.** В репозитории задан файл `.gitattributes`: в хранилище везде используется LF. На Windows при необходимости Git может подставлять CRLF при проверке файлов (настраивается локально). Рекомендация: на всех машинах выполнить один раз:
```bash
git config core.autocrlf input
```
(на Mac/Linux — так и оставить; на Windows при желании можно `core.autocrlf true`, тогда при checkout будет CRLF, при коммите — снова LF).

**7.2. Служебные файлы ОС.** В `.gitignore` добавлены артефакты macOS (`.DS_Store`, `._*`) и Windows (`Thumbs.db`, `Desktop.ini`), чтобы они не попадали в репозиторий.

**7.3. Пути в документации.** В документации не используются абсолютные пути конкретной ОС; при необходимости указывается «рабочая папка проекта» или «корень репозитория».

**7.4. Скрипты.** Для восстановления БД ias_vniic (имя в нижнем регистре — единый конфиг на всех ОС): на macOS/Linux — `scripts/create_and_restore_ias_vniic.sh`; на Windows — создать БД `ias_vniic` и выполнить `psql -d ias_vniic -f db\IAS_VNIIC_dump.sql` (при необходимости добавить аналогичный .cmd). Команды в документации (grep, find, sed) на Windows выполняются в Git Bash, WSL или аналоге.

**7.5. Общий репозиторий.** Достаточно одного удалённого репозитория (GitHub, GitLab, корпоративный Git); все трое работают через clone/pull/push с одной веткой или по принятой модели веток.

---

*Документ подготовлен в соответствии с правилами проекта и ориентирован на использование при проектировании и разработке ИАС учета на стеке PHP + Yii2 + PostgreSQL.*
