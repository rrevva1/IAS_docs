### Нормализованный план миграции и проектирования IAS на Django (Help Desk / Asset Management)

**Цель**: спроектировать и внедрить безопасную, поддерживаемую enterprise‑систему учёта техсредств + Help Desk + аналитика, с миграцией данных/файлов из текущего Yii2/PostgreSQL и сохранением совместимости с текущим фронтендом (AG Grid) через совместимый API.

#### Что это за система по смыслу (позиционирование)
IAS — это **полноценная информационно‑аналитическая система учёта технических средств предприятия**, где Help Desk является **одним из модулей**, а ядро системы — **учёт активов, их жизненный цикл, обслуживание/ремонты и аналитика**.

#### Текущее состояние и разрыв (gap) относительно целевой системы
- **В текущем коде Yii2** сейчас по сути реализован Help Desk (заявки) + пользователи/роли + вложения.
- **В текущей БД** уже предусмотрены сущности для учёта техники (например, `arm`, `locations` и связанные таблицы по характеристикам/истории), но этот контур **не полностью реализован/не доведён до уровня продукта** в приложении.
- **Учёт ПО и лицензий**: наличие в БД нужно подтвердить на фазе анализа (если таблиц нет — проектируем и добавляем в целевую модель).

#### Недостающие части проекта (кратко, что нужно достроить)
- **Полный жизненный цикл актива**: постановка на учёт → перемещения → закрепление за сотрудником/подразделением → ремонты/ТО → списание (с аудитом и историей).
- **Справочники и нормализация данных**: типы техники, модели, производители, подразделения, локации/кабинеты, причины ремонтов, подрядчики.
- **Массовые операции и импорт**: загрузки 100–1000 записей, массовые перемещения/назначения/списание, отчёт по ошибкам.
- **Связь Help Desk ↔ Активы**: заявка должна ссылаться на конкретный актив/группу активов; по активу должна быть видна история обращений.
- **Плановое обслуживание и уведомления**: календарь ТО, гарантия, уведомления по событиям.
- **Аналитика и отчётность**: KPI, отчёты по износу, ремонтам, гарантиям, загруженности исполнителей, закупочным потребностям.
- **Закупки**: формирование потребности на основе возраста/ремонтов/рисков; выгрузки в Excel/PDF.
- **ПО/лицензии (если требуется по бизнесу)**: каталог ПО, лицензии, связи «устройство → ПО», контроль истечения.

---

### 0) Вводные, границы и принципы

#### 0.1. Причины миграции
- Критические уязвимости безопасности (MD5 паролей, тестовые эндпоинты, утечки в логах).
- Архитектурные проблемы (смешение бизнес‑логики, отсутствие сервисного слоя).
- Дрейф схемы БД (несоответствие между кодом, миграциями и дампом).
- Требования enterprise: надежность, поддерживаемость, безопасность, наблюдаемость.

#### 0.2. Исходный и целевой стек
- **Исходный**: PHP 7.4+, Yii2 MVC, PostgreSQL 12+, фронт с AG Grid.
- **Целевой**: Python 3.11+, Django 5.x, PostgreSQL 14+, DRF (API под AG Grid), фоновые задачи (Celery/RQ), Redis (очереди/кэш) при необходимости.

#### 0.3. Архитектурный принцип
- **Модульный монолит**: несколько Django apps в одном деплое, без микросервисов на старте.
- **Слои ответственности**:
  - Web/API слой — тонкий.
  - Application layer (services/use‑cases) — бизнес‑операции.
  - Domain/policies — правила и доступ.
  - Infrastructure — БД/файлы/очереди/интеграции.

---

### 1) Требования

#### 1.1. Функциональные требования (FR)

**FR‑01 Учёт технических средств (Assets)**
- Регистрация нового оборудования (ПК, ноутбуки, оргтехника и т. д.) с указанием:
  - технических характеристик (CPU, RAM, накопитель, монитор и др.),
  - серийного и инвентарного номера,
  - даты покупки, даты ввода в эксплуатацию,
  - гарантийного срока,
  - ответственного сотрудника,
  - локации/кабинета,
  - имени АРМ/hostname, IP (если применимо).
- Пакетный ввод/массовые операции (массовые закупки, перемещения, переучёт).

**FR‑02 Мониторинг состояния и планирование обслуживания**
- Отслеживание плановых ТО, гарантии, фиксация неисправностей.
- Напоминания ответственным лицам.
- Календарь предстоящих обслуживаний и ремонтов.

**FR‑03 Управление ПО и лицензиями**
- Учёт установленного ПО (название, версия, ключи), сроков лицензий и уведомления.
- Связь «устройство → установленное ПО/лицензия».

**FR‑04 Help Desk / заявки + вложения**
- Создание/ведение заявок, статусы, назначение исполнителя, комментарии.
- Вложения (файлы) с контролем доступа: upload/download/preview.

**FR‑05 Аналитика и отчёты**
- Отчёты в PDF/HTML/Excel, дашборды (графики, диаграммы, KPI).
- Настраиваемые фильтры (подразделения, типы техники, даты и т. п.).

**FR‑06 Управление закупками**
- Планирование закупок оборудования/комплектующих на основе износа и статистики ремонтов.

**FR‑07 ИБ и разграничение доступа + аудит**
- Гибкая система ролей и прав (просмотр/редактирование/админ‑операции).
- Журнал действий (кто/что/когда изменил) и аудит критичных операций.

**FR‑08 История обслуживания и ремонтов**
- История ремонтов/ТО (дата, стоимость, подрядчик, результат).
- Быстрый поиск по истории поломок и обращений.

#### 1.2. Ввод данных и внешние интерфейсы

**UI ввод**
- Ручной ввод через Web UI.
- Валидация: запрет отрицательных значений, обязательность серийных/инвентарных номеров (по типам техники), формат дат.

**Импорт**
- Форматы: CSV, JSON, XML, XLSX.
- Кодировка UTF‑8.
- Пакеты 100–1000 записей.
- Отчёт об ошибках + частичная загрузка (по решению) с фиксацией результата.

**Диапазоны/форматы**
- Даты: DMY, не ранее 01‑01‑2000.
- Строковые поля: до 255 символов (UTF‑8), где применимо.

#### 1.3. Вывод данных

**UI**
- Web интерфейс + дашборды.
- Интерактивные фильтры/сортировка/поиск.

**Отчёты**
- PDF (статично), HTML (онлайн), Excel (для анализа).
- По запросу и по расписанию (сутки/неделя).

**Уведомления**
- Почта (SMTP) и/или интеграция через REST/Webhook.
- Триггеры: истечение гарантии/лицензии, критическая неисправность, плановое ТО.

**Аналитика**
- Прогнозы допускают погрешность ±5% (методика согласуется при проектировании).

---

### 2) Нефункциональные требования (NFR): производительность и объёмы

#### 2.1. Входные данные
- Размер записи: ~1–2 КБ.
- Пиковый ввод: до 300 записей в час.
- Система не высоконагруженная.

#### 2.2. Выходные данные
- Отчёт: 10–50 страниц.
- Графические элементы: до 5 МБ.
- Пиковое обновление дашбордов: раз в 30 минут.

**Обязательные меры**
- Пагинация на API, лимиты экспорта/импорта.
- Индексы по частым фильтрам.
- Фоновые задачи для тяжёлых операций (импорт, генерация отчётов, рассылки).

---

### 3) Проектирование целевой системы (Django)

#### 3.1. Структура проекта
```
helpdesk_ias/
├── config/              # settings, urls, wsgi/asgi
├── apps/
│   ├── core/            # общие утилиты, middleware, security
│   ├── users/           # CustomUser, группы/права
│   ├── assets/          # оборудование, локации, история
│   ├── tasks/           # Help Desk
│   ├── software/        # ПО и лицензии
│   ├── reports/         # отчёты/дашборды
│   ├── procurement/     # закупки
│   ├── audit/           # аудит-события
│   └── api/             # DRF под AG Grid
├── static/
├── templates/
└── manage.py
```

#### 3.2. Модель данных (high-level)
- Пользователи: `CustomUser` + Django `Groups/Permissions`.
- Роли: маппинг legacy `id_role` → Django Groups.
- Заявки: `Task` + справочник `TaskStatus` (через FK, чтобы сохранить соответствие дампу).
- Вложения: `Attachment` + связь `TaskAttachment` (FK вместо JSON).
- Активы: `Asset` + характеристики/комплектующие + история.
- ПО/лицензии: `Software`, `License`, `SoftwareInstall`.
- Аудит: `AuditEvent` (критичные события), корреляция по `request_id`.

#### 3.3. Безопасность (целевое состояние)
- Пароли: только Django hashers (argon2/bcrypt).
- **Legacy MD5**: не «конвертировать» хеши (это невозможно), а реализовать **прозрачный апгрейд при логине**:
  - если стандартная проверка не прошла — проверить `md5(raw)` с legacy‑хешем;
  - при успехе — `set_password(raw)` и очистить legacy‑хеш.
- Сессии/куки: `SESSION_COOKIE_SECURE`, `SESSION_COOKIE_HTTPONLY`, CSRF везде.
- Файлы: строгий ACL, запрет inline для опасных типов (например, SVG), `X-Content-Type-Options: nosniff`.

---

### 4) План работ по фазам (с артефактами и критериями приёмки)

#### Фаза 1 — Анализ и проектирование (1–2 недели)
**Задачи**
- Проанализировать дамп `ias_uch_vnii_public_dump.sql`.
- Построить ER‑диаграмму (users, roles, tasks, desk_attachments, arm, locations + связанные таблицы).
- Выявить связи, индексы, constraints.
- Зафиксировать расхождения дамп ↔ миграции Yii2 ↔ код.
- Зафиксировать **контракт API для AG Grid** (формат, поля, пагинация, фильтры, сортировка).
- Матрица доступа (группы/права).

**Артефакты / приёмка**
- ERD + документ связей.
- Документ “gaps” (расхождения и решения).
- Документ “AG Grid API contract”.
- RBAC matrix.

#### Фаза 2 — Настройка Django проекта (3–5 дней)
**Задачи**
- Инициализировать Django проект и apps‑структуру.
- `django-environ` для секретов.
- `django-debug-toolbar` (dev), `django-extensions`.
- Логирование: `security.log`, `audit.log`, `app.log`.

**Приёмка**
- Проект поднимается, секреты не захардкожены, есть `.env.example`.

#### Фаза 3 — Проектирование и реализация моделей (1–2 недели)
**Задачи**
- Реализовать модели и миграции (users/assets/tasks/software/audit).
- Вложения: FK‑связь, без JSON.
- Индексы под фильтры и отчёты.

**Приёмка**
- Миграции создают согласованную схему под прод.

#### Фаза 4 — Миграция данных и файлов (2–3 недели)
**Задачи**
- Сделать management commands миграции (идемпотентно).
- Файлы: перенос/линковка из `/web/uploads/tasks/` в `MEDIA_ROOT`.
- Legacy MD5: хранение legacy‑хеша + апгрейд при первом логине.
- Сверка целостности (counts + выборочные проверки).

**Приёмка**
- Повторный прогон миграции не портит данные.
- Вложения доступны только при наличии прав.

#### Фаза 5 — Реализация бизнес‑логики (3–4 недели)
**Задачи**
- Сервисный слой: `TaskService`, `AttachmentService`, `AssetService`, `LicenseService`, `ReportService`.
- Политики доступа, аудит критичных действий.
- Транзакционность операций “БД + файлы”.

**Приёмка**
- Нет бизнес‑логики в views; ключевые use‑cases покрыты тестами.

#### Фаза 6 — Web UI + API под AG Grid (2–3 недели)
**Задачи**
- DRF API: пагинация, оптимизация запросов, формат строго по контракту.
- Эндпоинты файлов: проверка прав + принадлежности вложения задаче.
- Django Admin: задачи + inline вложения, фильтры, массовые операции.

**Приёмка**
- Фронт (AG Grid) работает без изменений или с минимальными согласованными правками.

#### Фаза 7 — Безопасность, аудит, наблюдаемость (1 неделя)
**Задачи**
- Security hardening (OWASP Top 10 минимум).
- Аудит: событийный (не запись “каждый запрос” в БД), корреляция request_id.
- Sentry/мониторинг ошибок.

**Приёмка**
- Нет утечек секретов/паролей, аудит закрывает критичные операции.

#### Фаза 8 — Тестирование и деплой (1–2 недели)
**Задачи**
- Тесты: permissions, транзакции файлов, миграция данных, API контракт.
- Runbook деплоя: backup БД/файлов, read‑only окно, откат.

**Приёмка**
- Прогон тестов в CI, документированный деплой/rollback.

---

### 5) Ключевые требования к реализации (чек‑лист)
- Совместимость с AG Grid: **контракт ответа и фильтров фиксирован**.
- Безопасность: никакого MD5 “в новой системе”, никаких тестовых эндпоинтов, никаких паролей в логах.
- Целостность: FK вместо JSON, транзакции для операций с файлами.
- Производительность: пагинация, индексы, оптимизированные запросы.
- Наблюдаемость: аудит критичных действий, метрики/ошибки.

### 6) Ожидаемый результат
- **Безопасное**: покрыт минимум OWASP Top 10, корректные пароли, отсутствуют тестовые/опасные эндпоинты.
- **Поддерживаемое**: сервисный слой и разделение ответственности, документация.
- **Производительное**: пагинация, индексы, фоновые задачи для тяжёлых операций.
- **Масштабируемое**: модульная структура, возможность выделения частей позже при необходимости.

