# Описание разрабатываемой системы (по артефактам проекта)

## 1. Основание и источник сведений

### 1.1. Основание
Документ подготовлен по результатам анализа файлов, находящихся в рабочей папке проекта (корень репозитория).

### 1.2. Перечень проанализированных артефактов
В рабочей папке выявлено 44 файла, относящиеся к:

- документации исходного и целевого решения на PHP/Yii2 (`ias_php/docs/**`, `ias_uch_vnii/docs/**`);
- организационным правилам оформления требований (`pr.md`, `.cursor/rules/project-rules.mdc`);
- черновику ТЗ (`TZ.md`).

Примечание: файл `.cursor/._rules` является бинарным файлом без расширения и не поддается анализу штатными средствами чтения текста; функциональных сведений о системе из него извлечь не удалось. По формату имени предполагается служебный файл (метаданные файловой системы).

## 2. Назначение и контекст системы

### 2.1. Назначение
Разрабатываемая система представляет собой информационно-аналитическую систему предприятия, предназначенную для:

- учета технических средств (активов/оборудования) и связанных справочников;
- поддержки процессов Help Desk (учет заявок, статусов, назначение исполнителей, работа с вложениями);
- формирования аналитических выборок и отчетности по заявкам и активам;
- обеспечения аудита действий и разграничения доступа.

### 2.2. Контекст и границы
Реализация Системы выполняется на стеке PHP/Yii2 и PostgreSQL. Монолитное веб-приложение Help Desk с фронтендом на основе AG Grid развивается в рамках того же стека; перенос на иной технологический стек не планируется.

## 3. Участники и роли

### 3.1. Пользовательские роли (фактические и целевые)
В БД и коде приложения (ias_uch_vnii) фиксируются роли:

- `пользователь`;
- `оператор`;
- `администратор`.

Разграничение доступа реализуется на основе ролей (Yii2 RBAC или кастомные правила). Ключевой неопределенный аспект: бизнес-смысл роли **«оператор»** требует уточнения (диспетчер/исполнитель/административный оператор), так как от этого зависит перечень прав.

## 4. Основные функциональные контуры

### 4.1. Контур Help Desk (заявки)
Назначение: регистрация и сопровождение заявок пользователей с назначением исполнителей и контролем статусов.

Поддерживаемые операции по документам (as-is и target):

- создание заявки;
- просмотр списка заявок;
- просмотр деталей заявки;
- редактирование описания/комментария (с ограничениями по ролям);
- изменение статуса заявки;
- назначение/снятие исполнителя;
- формирование статистики по заявкам (в т.ч. по пользователям и исполнителям);
- экспорт статистики в Excel (упоминается в `ias_php/docs/guides/УЧЕБНЫЙ_README.md`).

### 4.2. Контур «Вложения» (файлы)
Назначение: прикрепление файлов к заявкам, просмотр/предпросмотр/скачивание, удаление вложений в рамках прав доступа.

As-is особенности по документам:

- хранение метаданных в таблице `desk_attachments`;
- хранение связи «заявка ↔ вложения» как JSON-строки в `tasks.attachments` (технический долг);
- поддержка предпросмотра изображений и PDF; в части документов указана поддержка SVG inline (является риск-фактором).

Целевые доработки (по ТЗ и плану реализации):

- нормализация связи вложений через таблицу связи (например, `task_attachments`);
- проверка прав на задачу и принадлежности вложения задаче при скачивании/preview;
- запрет inline preview для SVG и потенциально опасных типов; добавление заголовка `X-Content-Type-Options: nosniff`.

### 4.3. Контур учета технических средств (Assets/Equipment)
Назначение: учет активов предприятия и их жизненного цикла, связь с локациями и пользователями, фиксация истории событий.

По модели данных (см. `DB_ias.md`, `docs/ОСНОВНОЙ_УЧЕТ_И_БД.md`) рассматриваются сущности:

- актив/оборудование (Equipment/Asset);
- локации (Location);
- события истории актива (EquipHistory / EquipmentHistory);
- справочники комплектующих и характеристик (SprPart, SprChar) и значения характеристик (PartCharValue).

Ключевая функциональная связка: заявка Help Desk должна иметь связь с конкретным активом/группой активов, а по активу должна быть доступна история обращений (в документации указаны варианты FK или M2M).

### 4.4. Контур «ПО и лицензии» (Software/Licenses)
По ТЗ (п. 1.4.6) контур учёта ПО и лицензий входит в состав Системы: учёт программного обеспечения, сроков действия лицензий, связь «устройство → установленное ПО», уведомления об истечении лицензий. Реализация — в рамках этапов плана реализации (PHP/Yii2).

### 4.5. Контур аналитики и отчетности
По документации предусмотрены:

- интерактивные выборки и отчеты (в т.ч. экспорт в Excel);
- дашборды/графики (в исходном решении упоминается Highcharts);
- KPI и отчеты по активам (гарантии, ремонты, перемещения, списание) — как целевое развитие.

### 4.6. Контур закупок (Procurement)
В целевом плане обозначен как контур формирования потребности и планирования закупок на основе износа/ремонтов/рисков с возможностью выгрузки.

## 5. Интерфейсы и интеграции

### 5.1. Веб-интерфейс
По документации (as-is) предусматривается веб-интерфейс с:

- табличным представлением заявок (Kartik GridView и/или AG Grid);
- формами создания/редактирования;
- страницами статистики.

### 5.2. API для фронтенда (AG Grid)
Фактические эндпоинты и формат данных, используемые фронтендом (PHP-приложение ias_uch_vnii), описаны в проектной документации и в коде контроллеров.

Ключевые эндпоинты (as-is):

- `GET /index.php?r=tasks/get-grid-data` — данные заявок для AG Grid;
- `POST /index.php?r=tasks/change-status&id=...` — изменение статуса;
- `POST /index.php?r=tasks/assign-executor&id=...` — назначение исполнителя;
- `POST /index.php?r=tasks/update-comment&id=...` — обновление комментария;
- `GET /index.php?r=tasks/download&id=...` и `GET /index.php?r=tasks/preview&id=...` — работа с вложениями;
- `GET /index.php?r=tasks/get-user-equipment&userId=...` — перечень техники пользователя для detail panel.

Замечание по производительности: по контракту зафиксирован режим выдачи «всех записей без серверной пагинации» (клиентская фильтрация). В ряде документов по PHP указывается «серверная пагинация» для AG Grid; данное противоречие требует уточнения и фиксации в целевом контракте.

## 6. Данные и логическая модель (обобщение)

### 6.1. Основные сущности домена
По ERD baseline-схемы `ias_vnii` в рамках Help Desk и учета активов используются сущности:

- `roles` — роли пользователей;
- `users` — пользователи;
- `dic_task_status` — статусы заявок;
- `tasks` — заявки;
- `desk_attachments` — вложения;
- `locations` — локации;
- `equipment` — активы (оборудование);
- `equip_history` — история изменений/событий по активам;
- `spr_parts`, `spr_chars`, `part_char_values` — справочники и значения характеристик.

### 6.2. Технический долг по вложениям
Связь «заявка ↔ вложение» хранится в `tasks.attachments` как JSON-строка. Для целевой реализации предусмотрена нормализация (таблица связи), а также формализация формата миграции `tasks.attachments → task_attachments`.

### 6.3. Baseline и источники данных
В документах переноса выделяются:

- `ias_vnii` как baseline-схема для проектирования целевой модели;
- `ias_uch_vnii_public_dump.sql` как источник legacy-данных для миграции.

## 7. Безопасность, надежность и эксплуатационные требования (по выявленным материалам)

### 7.1. Выявленные риски и направления доработки
По анализу кода и документации выделены направления доработки:

- небезопасные практики обработки паролей (MD5 и связанные риски);
- наличие тестовых/опасных эндпоинтов в пользовательских/административных контроллерах;
- дрейф схемы БД (несоответствие между дампом, миграциями и кодом);
- недостаточно строгие проверки RBAC на серверной стороне по ряду операций;
- риск XSS при inline-preview SVG.

### 7.2. Целевые принципы безопасности (PHP/Yii2)
В реализации предусматриваются:

- корректное хеширование паролей (bcrypt/argon2), отказ от MD5;
- при необходимости — прозрачный апгрейд legacy-паролей при первом успешном логине;
- разграничение доступа на основе ролей и проверки прав на сервере;
- аудит критичных операций;
- ограничения на типы файлов предпросмотра и защитные заголовки.

### 7.3. Надежность и эксплуатация
В общих требованиях (см. `TZ.md` и `pr.md`) обозначены обязательные требования:

- резервное копирование и восстановление;
- регистрация ошибок и эксплуатационных событий;
- регламенты сопровождения и разграничения доступа.

## 8. Текущее состояние работ и степень готовности

### 8.1. Состояние артефактов в данной рабочей папке
В рабочей папке представлены:

- исходный код приложения на PHP/Yii2 (каталог `ias_uch_vnii/`: модели, контроллеры, миграции, представления);
- документация по архитектуре, БД, плану реализации и требованиям (TZ.md, DB_ias.md, ПЛАН_РЕАЛИЗАЦИИ.md, docs/**).

Реализация ведётся и развивается на стеке PHP + Yii2 + PostgreSQL; перенос на иной технологический стек не планируется.

### 8.2. Основные пробелы/неопределенности для последующего уточнения

1) **Роль «оператор»**: требуется формализовать бизнес-обязанности и права.

2) **Режим работы AG Grid**: требуется зафиксировать, является ли текущий режим полностью клиентским (без серверной пагинации) или реализована серверная пагинация/фильтрация, и определить целевой режим.

3) **Состав контуров beyond Help Desk**: требуется подтвердить необходимость и приоритет контуров «Активы», «ПО/лицензии», «Закупки», «Плановое обслуживание», «Уведомления» для ТЗ и дорожной карты.

4) **Базовые показатели объемов и производительности**: требуется определить целевые объемы данных и SLA на ключевые операции.

5) **Регламент миграции**: требуется зафиксировать исходные источники данных (дампы, рабочие БД), правила сопоставления схем и критерии успешной миграции.

## 9. Вывод (сводное описание системы)
По совокупности артефактов система представляет собой предприятие-ориентированную ИАС учета технических средств с модулем Help Desk, в которой:

- учет заявок и управление пользователями/ролями являются реализованным ядром приложения (PHP/Yii2);
- контур учета активов присутствует в предметной области и частично отражен в схемах данных; целевая схема БД — ias_uch_db_test (см. docs/ОПИСАНИЕ_И_ПЛАН_ДЕЙСТВИЙ_БД_ias_uch_db_test.md);
- развитие системы ведётся на том же стеке: нормализация модели вложений, усиление RBAC, аудит и стабилизация схемы данных;
- взаимодействие фронтенда с бэкендом обеспечивает контракт API для AG Grid с возможностью последующей оптимизации (серверная пагинация/фильтрация).

