# Функциональность загрузки файлов

## Обзор

В системе реализована полная функциональность загрузки и просмотра файлов для заявок пользователей. Пользователи могут прикреплять файлы (включая скриншоты) к своим заявкам, а администраторы могут просматривать и управлять этими файлами.

## Возможности

### Для пользователей:
- ✅ Загрузка множественных файлов через drag-and-drop или выбор файлов
- ✅ Поддержка изображений (JPG, PNG, GIF) для скриншотов
- ✅ Поддержка документов (PDF, DOC, DOCX, XLS, XLSX, TXT)
- ✅ Предварительный просмотр загружаемых файлов
- ✅ Валидация размера файлов (максимум 10 МБ)
- ✅ Просмотр загруженных изображений в модальном окне
- ✅ Скачивание прикрепленных файлов

### Для администраторов:
- ✅ Все возможности пользователей
- ✅ Удаление вложений
- ✅ Просмотр всех файлов в заявках
- ✅ Управление вложениями

## Технические детали

### Модели
- **DeskAttachments** - модель для хранения информации о файлах
- **Tasks** - модель задач с поддержкой множественных вложений

### Контроллеры
- **TasksController** - административные функции
- **UserTasksController** - пользовательские функции

### Поддерживаемые форматы
- **Изображения**: JPG, JPEG, PNG, GIF
- **Документы**: PDF, DOC, DOCX, XLS, XLSX, TXT

### Ограничения
- Максимальный размер файла: 10 МБ
- Максимальное количество файлов: 10
- Файлы сохраняются в `/web/uploads/tasks/`

## Использование

### Создание заявки с файлами

1. Перейдите на страницу создания заявки
2. Заполните описание проблемы
3. В разделе "Дополнительные файлы":
   - Перетащите файлы в область загрузки ИЛИ
   - Нажмите на область загрузки для выбора файлов
4. Просмотрите выбранные файлы в списке
5. При необходимости удалите ненужные файлы (кнопка ×)
6. Нажмите "Отправить заявку"

### Просмотр загруженных файлов

1. Откройте заявку
2. В разделе "Вложения" увидите все прикрепленные файлы
3. Для изображений:
   - Нажмите на миниатюру для просмотра в модальном окне
   - Используйте кнопку "Просмотр" для открытия в модальном окне
4. Для всех файлов:
   - Используйте кнопку "Скачать" для загрузки файла

### Управление файлами (администраторы)

1. В административной панели откройте заявку
2. В разделе "Вложения" доступны дополнительные действия:
   - Просмотр изображений
   - Скачивание файлов
   - Удаление вложений (кнопка корзины)

## Безопасность

- Проверка типов файлов на сервере
- Ограничение размера файлов
- Проверка прав доступа к файлам
- Безопасное именование файлов (timestamp + оригинальное имя)

## Структура файлов

```
/web/uploads/tasks/
├── 1703123456_screenshot.png
├── 1703123457_document.pdf
└── ...
```

## API Endpoints

### Для пользователей:
- `GET /user-tasks/view-attachment/{id}` - просмотр изображения
- `GET /user-tasks/download-attachment/{id}` - скачивание файла

### Для администраторов:
- `GET /tasks/view-attachment/{id}` - просмотр изображения
- `GET /tasks/download-attachment/{id}` - скачивание файла
- `POST /tasks/delete-attachment/{taskId}/{attachmentId}` - удаление вложения

## Troubleshooting

### Проблемы с загрузкой файлов:
1. Проверьте права доступа к папке `/web/uploads/tasks/`
2. Убедитесь, что размер файла не превышает 10 МБ
3. Проверьте формат файла (должен быть в списке поддерживаемых)

### Проблемы с просмотром изображений:
1. Убедитесь, что файл существует на диске
2. Проверьте права доступа к файлу
3. Убедитесь, что файл является изображением

## Обновления

### Версия 1.0 (Текущая)
- ✅ Базовая функциональность загрузки файлов
- ✅ Drag-and-drop интерфейс
- ✅ Предварительный просмотр изображений
- ✅ Модальное окно для просмотра
- ✅ Валидация файлов
- ✅ Безопасность и права доступа
