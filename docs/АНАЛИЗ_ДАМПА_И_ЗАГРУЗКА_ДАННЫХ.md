# Анализ дампов БД и загрузка данных из Основного учета

Подробный анализ двух дампов (legacy ↔ текущая схема), сравнение таблиц/полей/индексов и проектирование целевой БД приведены в **[DB_ias.md](../DB_ias.md)** — этот документ является основным по анализу и проектированию БД. Ниже — краткая сводка версий, загрузка из Основного учета и инструкции по восстановлению.

## Версии БД в проекте

| Версия БД | Файл дампа | Назначение |
|-----------|------------|------------|
| **Первая (legacy)** | **ias_uch_vnii_db** — `db/ias_uch_vnii_db.sql` | Исходная БД проекта на PHP (Yii2): схема с именами в стиле `id_arm`, `id_user`, `arm`, `spr_char`. |
| **Текущая (baseline)** | **ias_vnii_db** — `db/ias_vnii_db.sql` | Развитая схема: единый стиль `id`/`*_id`, таблицы `equipment`/`equip_history`, доп. таблицы (ПО, лицензии, аудит); также присутствуют служебные таблицы другого стека (auth_*, django_*), при работе на PHP не используются. |

ИАС будет работать с данными из Основного учета; целевая схема для хранения — **ias_uch_db_test** (см. `scripts/create_ias_uch_db_test.sql`) или **ias_vnii_db** после исключения из рассмотрения служебных таблиц, не относящихся к доменной БД.

### Сравнение: ias_uch_vnii_db (первая версия) ↔ ias_vnii_db (текущая)

| Область | ias_uch_vnii_db (PHP/Yii2) | ias_vnii_db |
|--------|----------------------------|-------------|
| Оборудование | `arm` (id_arm, id_user, id_location) | `equipment` (id, user_id, location_id) |
| История оборудования | `arm_history` (id_history, id_arm) | `equip_history` (id, equipment_id) |
| Характеристики | `spr_char` (id_char) | `spr_chars` (id) |
| Справочник частей | `spr_parts` (id_part) | `spr_parts` (id) |
| Значения характеристик | `part_char_values` (id_part_char, id_arm, id_part, id_char) | `part_char_values` (id, equipment_id, part_id, char_id) |
| Пользователи | `users` (id_user, id_role) | `users` (id, role_id) |
| Роли | `roles` (id_role) | `roles` (id) |
| Локации | `locations` (id_location) | `locations` (id) |
| Заявки | `tasks` (id_status, id_user) | `tasks` (status_id, user_id) |
| Статусы заявок | `dic_task_status` (id_status) | `dic_task_status` (id) |
| Вложения | `desk_attachments` (attach_id) | `desk_attachments` (id) |
| Миграции фреймворка | `migration` (Yii2) | `migration` (Yii2) + **django_***, **auth_***, **audit_events** |

В **ias_vnii_db** дополнительно есть: **software**, **licenses**, **software_installs** (учёт ПО и лицензий), **audit_events** (аудит). Таблицы auth_* и django_* к доменной БД не относятся; при эксплуатации на PHP целевая схема (ias_uch_db_test) их не включает.

---

## 1. Анализ дампа ias_vnii_db.sql (текущая схема)

### 1.1. Общие сведения

- **Источник:** `db/ias_vnii_db.sql`.
- **Формат:** дамп PostgreSQL (plain SQL), создан pg_dump 17.6, версия СУБД 17.4.
- **Схема:** `public`, владелец `postgres`.
- **Особенность:** ранее в дампе были директивы `\restrict`/`\unrestrict` (не стандарт PostgreSQL); они удалены, файл готов к восстановлению через `psql`.

### 1.2. Состав схемы (таблицы)

| Таблица | Назначение |
|--------|-------------|
| **users** | Работники организации (ФИО, должность, отдел, email, телефон, пароль, role_id) |
| **roles** | Роли пользователей |
| **equipment** | Оборудование/активы (name, user_id, location_id, description) |
| **locations** | Локации (кабинет/склад/серверная/лаборатория/другое, этаж) |
| **equip_history** | История изменений оборудования (equipment_id, changed_by, change_type, old_value, new_value) |
| **tasks** | Заявки Help Desk (status_id, description, user_id, executor_id, attachments — JSON) |
| **dic_task_status** | Справочник статусов заявок |
| **desk_attachments** | Вложения к заявкам (path, name, extension) |
| **spr_parts** | Справочник комплектующих/типов частей |
| **spr_chars** | Справочник характеристик (с единицами измерения) |
| **part_char_values** | Значения характеристик по оборудованию (part_id, char_id, equipment_id, value_text) |
| **software** | ПО (name, vendor, description) |
| **licenses** | Лицензии (key, valid_from, valid_to, seats, software_id) |
| **software_installs** | Установки ПО на оборудование (equipment_id, software_id, version, installed_at) |
| **audit_events** | События аудита (action, object_type, object_id, payload, actor_id) |
| **auth_group**, **auth_permission**, **auth_group_permissions** | Группы и права (в дампе ias_vnii_db; при PHP не используются) |
| **django_admin_log**, **django_content_type**, **django_migrations**, **django_session** | Служебные таблицы (в дампе ias_vnii_db; при PHP не используются) |
| **migration** | Версии миграций (Yii2) |

### 1.3. Ключевые связи для контура «Основной учет»

- **equipment** → **locations** (location_id), **users** (user_id).
- **equip_history** → **equipment** (equipment_id), **users** (changed_by).
- **part_char_values** → **equipment** (equipment_id), **spr_parts** (part_id), **spr_chars** (char_id).
- **users** → **roles** (role_id).

Данные в дампе уже присутствуют: оборудование (АРМ-301…АРМ-400, ICL i5), кабинеты, пользователи, роли, справочники. Восстановление дампа создаёт БД с этой схемой и данными.

---

## 2. Загрузка данных из «Основного учета» в БД

### 2.1. Источник данных

- **Файл:** `Основной Учет.xlsx` (в корне проекта).
- Готовый код загрузки из «Основной Учет.xlsx» в БД в приложении (ias_uch_vnii) может отсутствовать; реализация импорта активов (CSV/XLSX) предусматривается планом реализации (PHP или скрипты в `scripts/`).

### 2.2. Как загружать данные из Excel в ias_vnii_db

Общий подход:

1. **Восстановить БД** из дампа (см. раздел 3) — получится схема и при необходимости уже существующие данные.
2. **Определить структуру листа(ов)** в «Основной Учет.xlsx»: имена столбцов, листы (оборудование, локации, пользователи и т.д.).
3. **Реализовать загрузчик** (в приложении на PHP или отдельным скриптом), который:
   - читает листы/столбцы из Excel;
   - при необходимости дополняет справочники (**locations**, **roles**, **spr_parts**, **spr_chars**);
   - сопоставляет строки Excel с сущностями БД (по имени/коду/инв. номеру) или создаёт новые записи;
   - вставляет/обновляет данные в **equipment**, при необходимости в **users**, **locations**, **part_char_values**, **equip_history**.

Рекомендуемый порядок вставки с учётом внешних ключей:

1. **roles** (если в Excel есть роли).
2. **locations** (кабинеты/склады и т.п.) — по названию или коду.
3. **users** (ФИО, отдел, должность, привязка к role_id).
4. **equipment** (name, user_id, location_id, description); при наличии в Excel — инв. номер/серийный можно положить в name или description до появления отдельных полей в схеме.
5. При необходимости: **spr_parts**, **spr_chars**, затем **part_char_values** для характеристик по оборудованию.
6. При необходимости: записи в **equip_history** о постановке на учёт/перемещении.

### 2.3. Соответствие полей БД и типичных столбцов Excel (шаблон)

Ниже — ориентировочное соответствие. Имена столбцов в «Основной Учет.xlsx» могут отличаться; их нужно уточнить по файлу и при необходимости поправить скрипт.

| Таблица БД | Поле БД | Возможное имя/содержимое в Excel |
|------------|---------|-----------------------------------|
| equipment | name | Наименование / Инв. номер / АРМ |
| equipment | user_id | Ответственный / ФИО (поиск по users.full_name) |
| equipment | location_id | Кабинет / Локация / Адрес (поиск по locations.name) |
| equipment | description | Примечание / Описание |
| locations | name | Кабинет / Номер помещения |
| locations | location_type | кабинет \| склад \| серверная \| лаборатория \| другое |
| locations | floor | Этаж |
| users | full_name | ФИО |
| users | position | Должность |
| users | department | Подразделение / Отдел |
| users | role_id | Роль (по имени — маппинг в id из roles) |

Скрипт-шаблон загрузки из Excel в БД приведён в `scripts/load_osnovnoy_uchot.py` (см. раздел 4). После уточнения структуры «Основной Учет.xlsx» в скрипте нужно задать имена листов и столбцов и при необходимости маппинг значений.

---

## 3. Создание БД ias_vnii_db и восстановление дампа

### 3.1. Параметры подключения

- **Хост:** localhost (или иной по конфигурации).
- **Пользователь:** postgres.
- **Пароль:** 12345.
- **БД:** ias_vnii_db (создаётся пустой, затем в неё восстанавливается дамп).

### 3.2. Шаги

1. В дампе `db/ias_vnii_db.sql` уже удалены директивы `\restrict` и `\unrestrict` (файл готов к восстановлению).
2. Создать базу данных (если её ещё нет):
   ```bat
   set PGPASSWORD=12345
   psql -U postgres -h localhost -c "CREATE DATABASE ias_vnii_db;"
   ```
3. Восстановить дамп:
   ```bat
   set PGPASSWORD=12345
   psql -U postgres -h localhost -d ias_vnii_db -f "d:\Projects\TZ\db\ias_vnii_db.sql"
   ```

Готовый скрипт для Windows: `scripts/create_and_restore_db.cmd` (раздел 5).

---

## 4. Скрипт загрузки из «Основной Учет.xlsx» (шаблон)

Скрипт `scripts/load_osnovnoy_uchot.py`:

- Читает Excel (openpyxl/pandas).
- Ожидает в конфигурации имена листов и столбцов; при необходимости сначала заполняет справочники **locations** и **users** (по имени/коду).
- Вставляет записи в **equipment** с указанием location_id и user_id (по соответствию из Excel).

Перед запуском:

- Установить зависимости: `pip install pandas openpyxl psycopg2-binary`.
- Задать в скрипте строку подключения к БД (postgres/12345, ias_vnii_db) и фактические имена листов/столбцов в «Основной Учет.xlsx».

После уточнения структуры Excel скрипт можно доработать под конкретные листы и столбцы.

---

## 5. Краткое резюме

| Задача | Решение |
|--------|---------|
| Анализ дампа | Схема ИАС: пользователи, роли, оборудование, локации, заявки, справочники, ПО/лицензии, аудит. Дамп содержит и структуру, и данные. |
| Загрузка из «Основного учета» | Реализовать загрузчик (PHP или скрипт в `scripts/`): маппинг столбцов Excel → таблицы БД, порядок вставки с учётом FK. См. `docs/СТРУКТУРА_ЛИСТА_АРМ_ОСНОВНОЙ_УЧЕТ.md`, `ПЛАН_РЕАЛИЗАЦИИ.md`. |
| Создание БД ias_vnii_db | Создать БД, выполнить восстановление из `db/ias_vnii_db.sql` через psql. Скрипт — `scripts/create_and_restore_db.cmd`. |
