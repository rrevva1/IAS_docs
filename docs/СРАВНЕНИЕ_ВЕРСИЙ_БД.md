# Сравнение версий БД для выбора финальной схемы

Документ предназначен для сравнения трёх версий базы данных в DBeaver и определения финальной версии, а также объёма исправлений и дополнений.

---

## 1. Соответствие имён БД и источников схемы

| БД в DBeaver | Источник схемы (файл) | Назначение |
|--------------|------------------------|------------|
| **ias_uch_vnii** | `ias_uch_vnii/ias_uch_vnii_public_dump.sql` | Текущая БД PHP/Yii2-приложения (legacy). Стиль имён: id_arm, id_user, id_location, spr_char. |
| **ias_vnii_db** | `db/ias_vnii_db.sql` | Baseline v2: единый стиль id / *_id, таблицы equipment, equip_history, spr_chars; добавлены software, licenses, software_installs, audit_events; также присутствуют служебные таблицы auth_*/django_* (при работе на PHP не используются). |
| **ias_uch_db_test** | `scripts/create_ias_uch_db_test.sql` | Целевая расширенная схема под полное ТЗ: инв. номер, серийный номер, статус оборудования, связь заявка–актив, нормализованные вложения, RBAC, аудит, импорт. |

---

## 2. Сводка таблиц по версиям

| Таблица / сущность | ias_uch_vnii | ias_vnii_db | ias_uch_db_test |
|-------------------|:------------:|:-----------:|:---------------:|
| Оборудование | arm | equipment | equipment |
| История оборудования | arm_history | equip_history | equip_history |
| Пользователи | users | users | users |
| Роли | roles | roles | roles |
| Связь пользователь–роль | — (users.id_role) | — (users.role_id) | user_roles (M2M) |
| Права (permissions) | — | — | permissions, role_permissions |
| Локации | locations | locations | locations |
| Статусы заявок | dic_task_status | dic_task_status | dic_task_status |
| Статусы оборудования | — | — | dic_equipment_status |
| Типы частей | spr_parts | spr_parts | spr_parts |
| Характеристики | spr_char | spr_chars | spr_chars |
| Значения характеристик | part_char_values | part_char_values | part_char_values |
| Заявки | tasks | tasks | tasks |
| История заявок | — | — | task_history |
| Связь заявка–оборудование | — | — | task_equipment |
| Вложения | desk_attachments | desk_attachments | desk_attachments |
| Связь заявка–вложение | — (tasks.attachments JSON) | — (tasks.attachments text) | task_attachments |
| ПО и лицензии | — | software, licenses, software_installs | — |
| Аудит | — | audit_events | audit_events |
| Импорт из Excel | — | — | import_runs, import_errors |
| Журнал изменений НСИ | — | — | nsi_change_log |
| Служебные (другой стек) | — | auth_*, django_* в ias_vnii_db | — (при PHP не используются) |

---

## 3. Детальное сравнение ключевых сущностей

### 3.1. Оборудование (arm / equipment)

| Поле / требование | ias_uch_vnii (arm) | ias_vnii_db (equipment) | ias_uch_db_test (equipment) |
|-------------------|--------------------|-------------------------|-----------------------------|
| PK | id_arm | id | id (BIGSERIAL) |
| Наименование | name | name | name |
| Инв. номер | нет (только в name/description) | нет | **inventory_number** NOT NULL UNIQUE |
| Серийный номер | нет | нет | **serial_number** UNIQUE |
| Тип техники | нет | нет | **equipment_type** |
| Ответственный | id_user | user_id | **responsible_user_id** |
| Локация | id_location | location_id | location_id |
| Описание | description | description | description |
| Статус оборудования | нет | нет | **status_id** → dic_equipment_status |
| Поставщик | нет | нет | **supplier** |
| Дата поступления | нет | нет | **purchase_date** |
| Дата ввода в эксплуатацию | нет | нет | **commissioning_date** |
| Гарантия до | нет | нет | **warranty_until** |
| Мягкое удаление / архив | нет | нет | **is_deleted**, **is_archived**, **archived_at**, **archive_reason** |
| Аудит (created_at, updated_at, created_by) | created_at | created_at | **created_at**, **updated_at**, **created_by_id**, **updated_by_id** |

**Вывод:** для Основного учёта (лист АРМ) и полного ТЗ достаточна только схема **ias_uch_db_test**. В ias_uch_vnii и ias_vnii_db нет отдельных полей под инв. номер, тип техники, поставщика, даты, статус.

### 3.2. История оборудования (arm_history / equip_history)

| Поле | ias_uch_vnii | ias_vnii_db | ias_uch_db_test |
|------|--------------|-------------|-----------------|
| PK | id_history | id | id (BIGSERIAL) |
| Оборудование | id_arm | equipment_id | equipment_id |
| Кто изменил | changed_by | changed_by | changed_by |
| Тип изменения | change_type | change_type | **event_type** (create, update, move, assign, status_change, writeoff, archive…) |
| Старое/новое значение | old_value, new_value (text) | old_value, new_value (text) | **old_value**, **new_value** (JSONB) |
| Дата | change_date | change_date | **changed_at** (TIMESTAMPTZ) |
| Комментарий | comment | comment | comment |

**Вывод:** ias_uch_db_test даёт типизированные события и JSONB для структурированного хранения изменений.

### 3.3. Заявки (tasks)

| Поле | ias_uch_vnii | ias_vnii_db | ias_uch_db_test |
|------|--------------|-------------|-----------------|
| PK | id | id | id (BIGSERIAL) |
| Номер заявки | нет | нет | **task_number** UNIQUE |
| Заголовок | нет | нет | **title** |
| Описание | description | description | description |
| Статус | id_status | status_id | status_id |
| Автор | user_id | user_id | **requester_id** |
| Исполнитель | executor_id | executor_id | executor_id |
| Приоритет | нет | нет | **priority** (low, medium, high, critical) |
| Срок | нет | нет | **due_at**, **closed_at** |
| Вложения | attachments (text/JSON) | attachments (text) | **attachments_legacy** (JSONB) + таблица **task_attachments** |
| Связь с оборудованием | нет | нет | таблица **task_equipment** (M2M) |
| Мягкое удаление | нет | нет | **is_deleted**, **deleted_at**, **deleted_by**, **delete_reason** |
| Дата создания/обновления | date, last_time_update | date, last_time_update | **created_at**, **updated_at** |

**Вывод:** в ias_uch_db_test реализованы связь заявка–оборудование (ТЗ 5.1.6), нормализованная связь заявка–вложение (ТЗ 5.1.4), приоритет и сроки.

### 3.4. Вложения (desk_attachments)

| Поле | ias_uch_vnii | ias_vnii_db | ias_uch_db_test |
|------|--------------|-------------|-----------------|
| PK | attach_id | id | id (BIGSERIAL) |
| Путь/хранилище | path | path | **storage_path** |
| Имя файла | name | name | **original_name** |
| Расширение | extension | extension | **file_extension** |
| MIME, размер, checksum | нет | нет | **mime_type**, **size_bytes**, **checksum_sha256** |
| Кто загрузил | нет | нет | **uploaded_by**, **uploaded_at** |
| Мягкое удаление | нет | нет | **is_deleted**, **deleted_at**, **deleted_by** |

Связь «заявка – вложение»: в ias_uch_vnii и ias_vnii_db только через tasks.attachments (JSON/text). В **ias_uch_db_test** — таблица **task_attachments** (task_id, attachment_id).

### 3.5. Пользователи и роли

| Поле / аспект | ias_uch_vnii | ias_vnii_db | ias_uch_db_test |
|---------------|--------------|-------------|-----------------|
| PK пользователя | id_user | id | id (BIGSERIAL) |
| Роль | id_role (FK в users) | role_id (FK в users) | M2M **user_roles** (несколько ролей на пользователя) |
| Отдельная таблица прав | нет | нет | **permissions**, **role_permissions** |
| Логин | нет (auth_key, access_token) | auth_key, access_token | **username** UNIQUE |
| Пароль | password (varchar 100) | password | **password_hash** |
| Блокировка, попытки входа | нет | нет | **is_active**, **is_locked**, **failed_login_attempts**, **lock_until** |
| Мягкое удаление | нет | нет | **is_deleted** |
| Аудит | created_at | created_at | **created_at**, **updated_at**, **created_by_id**, **updated_by_id** |

Справочник ролей: в ias_uch_db_test — **roles** с role_code, role_name, is_system, is_archived; **dic_task_status** и **dic_equipment_status** с status_code, sort_order, is_final.

### 3.6. part_char_values (характеристики оборудования)

| Поле | ias_uch_vnii | ias_vnii_db | ias_uch_db_test |
|------|--------------|-------------|-----------------|
| Ссылка на оборудование | id_arm | equipment_id | equipment_id |
| Ссылка на часть/характеристику | id_part, id_char | part_id, char_id | part_id, char_id |
| Значение (текст) | value_text | value_text | value_text |
| Значение (число) | нет | нет | **value_num** |
| Источник/обновление | нет | нет | **source**, **updated_by**, **updated_at** |

---

## 4. Рекомендация: финальная версия БД

**В качестве финальной схемы рекомендуется использовать ias_uch_db_test** (DDL в `scripts/create_ias_uch_db_test.sql`), потому что она:

1. Покрывает полный объём ТЗ: инв. номер, серийный номер, тип техники, поставщик, даты, статус оборудования (в т.ч. для Основного учёта по листу АРМ).
2. Содержит связь заявка–оборудование (task_equipment) и нормализованную связь заявка–вложение (task_attachments).
3. Включает справочник статусов оборудования (dic_equipment_status), RBAC (роли, права, user_roles), аудит (audit_events) и протоколы импорта (import_runs, import_errors).
4. Поддерживает мягкое удаление и архивирование, историчность (equip_history с event_type, task_history).

При этом:
- **ias_uch_vnii** — текущая рабочая БД PHP-приложения; её данные нужно переносить в целевую схему с маппингом имён (arm→equipment, id_arm→id, id_user→responsible_user_id и т.д.).
- **ias_vnii_db** — промежуточная схема (v2); содержит software/licenses/software_installs и audit_events, а также служебные таблицы auth_*/django_* (при эксплуатации на PHP не используются). Не содержит полей оборудования под Основной учёт (инв. номер, тип, поставщик, даты, статус). Может использоваться как источник данных при миграции с приведением к схеме ias_uch_db_test.

---

## 5. Что исправить и добавить при переходе на финальную версию

### 5.1. Если финалом является ias_uch_db_test

- **Доработать приложение (ias_uch_vnii):** переключить `config/db.php` на БД с целевой схемой (или создать миграции, приводящие текущую БД к схеме ias_uch_db_test). Обновить модели и контроллеры под новые имена и поля (equipment: inventory_number, status_id, responsible_user_id, supplier, purchase_date, commissioning_date, warranty_until; task_equipment; task_attachments и т.д.).
- **Миграция данных из ias_uch_vnii:**
  - arm → equipment (id_arm→id, name→name, id_user→responsible_user_id, id_location→location_id, description→description; inventory_number заполнить из name или отдельного поля при наличии).
  - Заполнить dic_equipment_status и проставить equipment.status_id (например, «в эксплуатации» по умолчанию).
  - users, roles, locations, spr_parts, spr_char→spr_chars, part_char_values, tasks, desk_attachments — маппинг по таблицам из раздела 4.1 в DB_ias.md.
  - tasks.attachments (JSON) → разобрать и вставить строки в task_attachments.
- **Миграция данных из ias_vnii_db:** схема уже близка к стилю id/*_id; добавить в целевую схему недостающие поля (inventory_number, status_id, supplier, даты и т.д.), заполнить их из имеющихся данных или оставить NULL/default; при необходимости перенести software, licenses, software_installs в отдельный контур или добавить аналоги в ias_uch_db_test.
- Таблицы auth_* и django_* из ias_vnii_db в финальную схему для PHP не включать.

### 5.2. Таблицы, которые есть только в ias_vnii_db

| Таблица | Действие в финальной версии |
|---------|-----------------------------|
| software, licenses, software_installs | Либо добавить в ias_uch_db_test при необходимости контура «ПО и лицензии», либо не переносить. |
| auth_*, django_* | Не включать в финальную схему учёта ТС при работе на PHP. |

### 5.3. Обязательные изменения при выборе ias_uch_db_test

1. В **equipment:** обязательно заполнять **inventory_number** (NOT NULL UNIQUE), при миграции из arm — сгенерировать или взять из name/description.
2. В **equipment:** добавить и заполнить **status_id** (FK на dic_equipment_status), при миграции — один статус по умолчанию (например, «в эксплуатации»).
3. Ввести **task_attachments** и при миграции перенести связи из tasks.attachments (JSON/text) в строки task_attachments.
4. Реализовать в приложении использование **task_equipment** для связи заявок с активами (ТЗ 5.1.6).
5. При необходимости учёта ПО и лицензий — добавить в целевую схему таблицы по образцу ias_vnii_db или оставить отдельный контур.

---

## 6. Порядок действий в DBeaver для сравнения

1. Подключить три БД: ias_uch_vnii, ias_vnii_db, ias_uch_db_test (при отсутствии — создать пустые БД и применить соответствующие SQL-скрипты).
2. В каждой БД открыть «Таблицы» (public) и сверить список таблиц с разделом 2 данного документа.
3. Для ключевых таблиц (оборудование, заявки, пользователи, вложения) сравнить столбцы с разделами 3.1–3.6.
4. Зафиксировать отличия по своему проекту (например, в копии этой таблицы с пометками).
5. Принять решение о финальной версии (рекомендуется ias_uch_db_test) и спланировать миграции и доработки приложения по разделу 5.

---

## 7. Краткая итоговая таблица

| Критерий | ias_uch_vnii | ias_vnii_db | ias_uch_db_test |
|----------|:------------:|:-----------:|:---------------:|
| Используется в проде (PHP) | да | нет | нет |
| Стиль имён (id, *_id) | нет (id_*) | да | да |
| Поля под Основной учёт (инв. номер, тип, поставщик, даты, статус) | нет | нет | да |
| Связь заявка–оборудование | нет | нет | да |
| Нормализованная связь заявка–вложение | нет | нет | да |
| Справочник статусов оборудования | нет | нет | да |
| RBAC (роли/права/M2M) | упрощённо | упрощённо | да |
| Аудит, импорт, мягкое удаление | нет | частично | да |
| **Рекомендация как финал** | источник данных | источник данных | **целевая схема** |

После выбора финальной версии все доработки и миграции следует вести к схеме **ias_uch_db_test** и при необходимости обновлять DDL в `scripts/create_ias_uch_db_test.sql` и документацию в `docs/МОДЕЛЬ_БД_ias_uch_db_test.md`, `DB_ias.md`, `docs/ОСНОВНОЙ_УЧЕТ_И_БД.md`.
