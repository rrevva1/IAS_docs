# Анализ текущего состояния ИАС учёта технических средств

Документ подготовлен по состоянию репозитория и кода приложения. Цель — зафиксировать, что реализовано, что осталось сделать и какие изменения целесообразно внести.

---

## 1. Существование системы: общая оценка

Система **существует** в виде рабочего прототипа на стеке PHP (Yii2) + PostgreSQL с веб-интерфейсом (AG Grid). Реализованы ядро Help Desk, учёт активов (оборудования), управление пользователями, частично — вложения, справочники, отчётность, аудит и контур «ПО и лицензии». Документация (ТЗ, модель БД, план реализации, требования) приведена в порядок и привязана к ВКР и эксплуатации.

**Вывод:** система находится в стадии активной разработки и доработки; до промышленной эксплуатации необходимо закрыть пробелы по безопасности, правам доступа, импорту данных и ряду функциональных контуров.

---

## 2. Что реализовано (по контурам)

| Контур | Реализовано | Примечание |
|--------|-------------|------------|
| **Пользователи, роли, доступ** | CRUD пользователей, аутентификация, разграничение по ролям (админ/пользователь), восстановление пароля с аудитом | Риски ИБ: MD5 в коде (см. п. 4); тестовые экшены требуют ограничения |
| **Справочники** | Статусы заявок, роли, локации; ReferencesController | Нет отдельного модуля CRUD справочников; архивирование и история изменений справочников не реализованы |
| **Help Desk (заявки)** | CRUD, смена статуса, назначение исполнителя, комментарии, видимость по ролям в списке, фильтрация | Проверка прав на просмотр/редактирование одной заявки и на вложения — по плану (первая волна); централизованная проверка `canUserAccessTask` — уточнить по коду |
| **Вложения** | Загрузка, скачивание, предпросмотр, удаление; хранение в `web/uploads/tasks/`, связь через JSON в `tasks.attachments` | Нормализация связи (таблица `task_attachments`), проверка прав при download/preview, запрет inline для SVG, заголовок X-Content-Type-Options — по плану |
| **Учёт активов** | Список, создание, просмотр, редактирование, переназначение (reassign), архивирование; вкладки по типу техники; AG Grid с настройкой колонок и локализацией | Карточка актива (view/update) реализована; история оборудования (equip_history) — проверить наличие в схеме и UI |
| **Конфигурация оборудования** | Динамическая форма по типу техники (ЦП, ОЗУ, Диск и т.д.), сохранение в part_char_values | Модели spr_parts, spr_chars, part_char_values — по коду и плану должны быть |
| **Связь заявка–актив** | — | В плане — третья волна; в коде и схеме требуется уточнение |
| **Интерфейсы для фронтенда** | get-grid-data, change-status, assign-executor, update-comment, get-user-equipment; пагинация (в т.ч. «показывать все») | Проверка прав в get-user-equipment и серверная пагинация — по плану |
| **Поиск, фильтрация** | По заявкам и активам; фильтры в журнале аудита | Реализовано |
| **Отчётность и экспорт** | Статистика (Highcharts), экспорт в Excel | PDF/HTML по ТЗ — при необходимости |
| **Аудит** | Таблица audit_events, компонент AuditLog, записи при создании/обновлении/удалении заявок, активов, ПО/лицензий, сбросе пароля; экран журнала с фильтрами (AuditController, get-grid-data) | Реализовано; при отсутствии записей — проверить БД и права |
| **ПО и лицензии** | SoftwareController: CRUD ПО, лицензий, привязка ПО к оборудованию; аудит операций | Контур начат; уведомления об истечении лицензий — по ТЗ уточнить |
| **Импорт** | ImportController присутствует | Универсальный импорт CSV/XLSX и загрузка из «Основной Учет.xlsx» по регламенту — в плане (третья волна) |

---

## 3. Что ещё нужно сделать

### 3.1. Обязательно (безопасность и права)

- **Нулевая волна (по ПЛАН_РЕАЛИЗАЦИИ):**
  - Заменить MD5 на bcrypt/argon2 при хранении и проверке паролей; убрать логирование пароля в debug.
  - Ограничить или удалить тестовые/опасные экшены в UsersController (actionResetPassword, actionTestPasswords, actionIndex2).
  - В actionDownload и actionPreview проверять принадлежность вложения заявке и права текущего пользователя на эту заявку; при отказе — 403.
  - Для SVG в предпросмотре не использовать inline; для всех отдач файлов добавлять заголовок X-Content-Type-Options: nosniff.
  - В actionGetUserEquipment разрешать данные только для текущего пользователя или администратора.
- **Первая волна:**
  - Централизованная проверка доступа к заявке (canUserAccessTask) во всех операциях (view, update, delete, change-status, assign-executor, update-comment, вложения).
  - Корректное использование первичного ключа пользователей (id) в getUsersList и выпадающих списках исполнителей.

### 3.2. Документация и проектные решения (этап 1–2)

- Зафиксировать роль «оператор»: функции, права на данные, ограничения; обновить матрицу доступа (docs/sistema/РОЛИ_И_ПРАВА_ДОСТУПА.md, TZ).
- Зафиксировать режим AG Grid: клиентская или серверная пагинация/фильтрация; при серверной — спецификация API.
- Принять решение по схеме импорта: arm vs equipment (docs/ОСНОВНОЙ_УЧЕТ_И_БД.md).
- Актуализировать спецификацию API (эндпоинты, форматы, коды ошибок).

### 3.3. Функциональные пробелы

- Связь «заявка — актив(ы)»: таблица связи, выбор активов в форме заявки, блок «Связанные заявки» в карточке актива.
- Нормализация вложений: таблица task_attachments, миграция данных из tasks.attachments (JSON).
- Импорт из «Основной Учет.xlsx» (лист АРМ): загрузчик по регламенту, порядок вставки (locations → users → equipment → part_char_values → history), валидация, протокол и контрольные сверки.
- Универсальный импорт CSV/JSON/XML/XLSX по п. 5.1.11 ТЗ (форматы, протокол, валидация).
- Контур «ПО и лицензии»: уведомления об истечении лицензий (способ и регламент — по обследованию).
- По ТЗ при необходимости: экспорт в PDF/HTML; серверная пагинация для AG Grid при росте объёмов.

### 3.4. Этапы 4–7 плана

- Этап 4: скрипты миграции/импорта, регламент, контрольные сверки.
- Этап 5: модульные и интеграционные испытания, проверка производительности и безопасности.
- Этап 6: приёмочные испытания, руководство пользователя/администратора, регламенты.
- Этап 7: пилотная и промышленная эксплуатация.

### 3.5. ВКР (первые две главы)

По docs/vkr/ПЕРЕЧЕНЬ_ДОКУМЕНТАЦИИ.md для 50–60 стр. не хватает развёрнутых разделов:

- 1.1 Постановка проблемы (3–5 стр.).
- 1.3 Анализ существующих решений и аналогов (5–10 стр.).
- 1.4 Сравнение подходов (3–5 стр.).
- 2.1 Обоснование архитектурного стиля (3–5 стр.).
- 2.2 Компонентная структура (4–6 стр.).
- 2.4 Проектирование UI/UX (4–8 стр.).

---

## 4. Предлагаемые изменения и рекомендации

### 4.1. Приоритизация работ

1. **В первую очередь:** нулевая волна (пароли, тестовые экшены, права на вложения и get-user-equipment, SVG и nosniff). От этого зависит безопасность при тестовой и промышленной эксплуатации.
2. **Далее:** первая волна (права на заявки, getUsersList, задел под аудит уже есть — расширить охват событий при необходимости).
3. **Параллельно:** закрыть минимум по этапу 1 (роль «оператор», режим AG Grid, схема импорта) и зафиксировать в документации.

### 4.2. Унификация и качество кода

- Ввести единый формат ответов API (успех/ошибка, коды, сообщения) и описать его в спецификации API.
- Доработать UX: единообразные всплывающие уведомления (успех/ошибка) по всем CRUD-операциям (в т.ч. пользователи, заявки, активы).
- Проверить видимость заявок по RBAC: администратор и оператор — все заявки; обычный пользователь — только свои или где он исполнитель; при необходимости зафиксировать в коде и в docs/sistema/РОЛИ_И_ПРАВА_ДОСТУПА.md.

### 4.3. Данные и импорт

- Зафиксировать единый источник истины по схеме: DDL в scripts/create_ias_vniic.sql (или аналог) и docs/bd/МОДЕЛЬ_БД_ias_vniic.md; миграции Yii2 синхронизировать с этой схемой.
- Реализовать загрузчик из «Основной Учет.xlsx» (лист АРМ) с протоколом и валидацией; при наличии Python-скрипта — доработать или продублировать логику в PHP (консольная команда Yii2 или экран для админа).

### 4.4. Очистка репозитория

- По docs/sluzhebnye/СПИСОК_ФАЙЛОВ_К_УДАЛЕНИЮ.md: удалить файлы `._*` (AppleDouble); при необходимости — current_db_schema.sql, RunPgSqlFile.class; решение по helpdesk_ias_py, Vagrant, Docker — по факту использования.
- Добавить в .gitignore артефакты сравнения и сгенерированные схемы, чтобы они не попадали в коммиты.

### 4.5. Документация

- Актуализировать SYSTEM_DESCRIPTION.md и ПЛАН_РЕАЛИЗАЦИИ.md с учётом уже реализованных контуров (аудит, ПО/лицензии, карточка актива, вкладки по типу техники, журнал аудита).
- Обновить Следующие_шаги.md и docs/planning/ДОРАБОТКИ_СТАТУС.md по текущему состоянию кода.
- Ввести или обновить docs/СПЕЦИФИКАЦИЯ_API.md (список эндпоинтов, методы, параметры, форматы ответов, коды ошибок).

### 4.6. ВКР

- Дописать недостающие разделы глав 1–2 (постановка проблемы, аналоги, сравнение подходов, обоснование архитектуры, компонентная структура, UI/UX) на основе имеющихся TZ.md, SYSTEM_DESCRIPTION.md, модели БД и плана реализации.

---

## 5. Сводная таблица: состояние по этапам

| Этап | Статус | Действия |
|------|--------|----------|
| 1. Обследование и уточнение требований | Частично | Зафиксировать роль «оператор», режим AG Grid, схему импорта; обновить матрицу прав |
| 2. Проектные решения | Частично | Актуализировать описание архитектуры, спецификацию API, модель доступа |
| 3. Разработка | В процессе | Нулевая и первая волны; связь заявка–актив; нормализация вложений; импорт ОУ; контур ПО/лицензии (уведомления) |
| 4. Миграция/импорт | Частично | Регламенты и структура листа есть; реализовать загрузчик и протокол |
| 5. Испытания | Не начато | Программа и методика; модульные и интеграционные проверки; безопасность и производительность |
| 6. Документация и обучение | Частично | Руководства пользователя и администратора; регламенты эксплуатации |
| 7. Ввод в эксплуатацию | Не начато | Инфраструктура, ответственные, приёмка |

---

## 6. Заключение

Система существует как работоспособный прототип с развитой документацией и планом реализации. Критично довести до конца меры безопасности (нулевая волна) и централизованные проверки прав (первая волна), закрыть неопределённости этапа 1 и реализовать связь заявка–актив, импорт из «Основной Учет.xlsx» и при необходимости нормализацию вложений. После этого целесообразно перейти к формальным испытаниям и подготовке к вводу в эксплуатацию. Предложенные изменения (приоритизация, унификация API и UX, очистка репозитория, актуализация документации) направлены на упорядочивание разработки и приведение артефактов в соответствие с фактическим состоянием системы.
