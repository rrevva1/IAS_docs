# Регламент парсинга ОУ_тест.xlsx

Единый документ правил парсинга листа «АРМ» файла ОУ_тест.xlsx при загрузке в БД. Все решения по столбцам, особым значениям и неоднозначностям фиксируются здесь; скрипт загрузки и описание примеров (первые 10 строк) должны следовать этому регламенту.

---

## 1. Общие правила

| Правило | Описание |
|---------|----------|
| **Разделитель неатомарных ячеек** | Только перенос строки (`\n`). Запятая в данных (например, «3,3 ГГц» в ЦП) **не** разделитель — значение хранится целиком. |
| **Помещение** | Число (103, 105) приводить к строке для `locations.name`: `"103"`, `"105"`. |
| **Пустые ячейки** | Не заполняем целевые поля (NULL / пропуск записи в part_char_values). |
| **Семантика строки** | Одна строка листа даёт **одну запись equipment** на ПК (или одну запись «только монитор» при отсутствии СБ); **плюс** по п. 1.1 — отдельные записи equipment на каждый монитор из столбца «Монитор» и на каждый ИБП из столбца «Другая техника». Инв. номер ПК — из «№ системн. блока» или «№ монитора» по правилу наличия СБ; мониторы и ИБП — синтетические МЦ.04-mon-XXX, МЦ.04-ups-XXX. |
| **Ссылка на регламент** | При реализации парсера/загрузчика использовать **только** этот документ как источник правил по столбцам и особым значениям. |

### 1.1. Разнесение мониторов и ИБП: одна запись equipment = один физический актив

В системе принят принцип **одна запись в таблице equipment = одна физическая единица техники** (см. `docs/sistema/УТОЧНЕНИЕ_УЧЕТ_МОНИТОРЫ_ИБП_МЦ04.md`). При парсинге листа АРМ это означает:

| Объект | В источнике (ячейка) | В БД после загрузки |
|--------|----------------------|----------------------|
| **Мониторы** | Столбец «Монитор»: одно значение или несколько через `\n`, `; ` (например «AOC 24P2Q; AOC 24P2Q», «Philips 23.8" 241B8QJEB\nPhilips 23.8" 241B8QJEB»). | На каждую **физическую единицу** создаётся **отдельная запись equipment** с equipment_type = «Монитор», тем же responsible_user_id и location_id, что у строки-ПК. Наименование (equipment.name) — модель этого монитора. Инв. номер — синтетический **МЦ.04-mon-XXX** (мониторы учёт МЦ.04, инв. номера в бухгалтерии не присваиваются). Для строки-ПК в **part_char_values** по-прежнему можно сохранить конфигурацию (тип части «Монитор», значение — модель/модели для справки). |
| **ИБП** | Столбец «Другая техника»: текст вида «ИБП &lt;марка и модель&gt;» (например «ИБП APC Back-UPS 650 ВА (BX650CI-RS)», «ИБП Powercom RPT-1000A EURO»). В одной ячейке может быть один ИБП или несколько через `\n`. | На каждый ИБП создаётся **отдельная запись equipment** с equipment_type = «ИБП», тем же responsible_user_id и location_id, что у строки-ПК. equipment.name = текст после «ИБП » (марка и модель). Инв. номер — синтетический **МЦ.04-ups-XXX**. В **equipment.description** строки-ПК переносить ИБП **не** оставляем (после извлечения поле очищается или в него не пишем эти подстроки). |

**Итог для парсера:**

- **Столбец «Монитор»:** разбить значение по разделителям (`\n`, при необходимости `; `); для каждой подстроки (модель монитора) создать запись equipment (тип «Монитор», name = подстрока, inventory_number = МЦ.04-mon-001, …); для строки-ПК при необходимости заполнить part_char_values (Монитор) — по одному или несколько значений для отображения конфигурации в гриде.
- **Столбец «Другая техника»:** найти подстроки, начинающиеся с «ИБП »; для каждой такой подстроки создать запись equipment (тип «ИБП», name = текст после «ИБП », inventory_number = МЦ.04-ups-001, …); в description записи ПК не класть извлечённые ИБП.

Нумерация МЦ.04-mon-XXX и МЦ.04-ups-XXX — сквозная в рамках одного запуска загрузки (или по регламенту генерации уникальных номеров).

---

## 2. Правила по столбцам (по порядку)

Для каждого столбца указаны: смысл значения, куда грузить, особые значения, примечания и нерешённые вопросы.

---

### Столбец 1 — Пользователь

| Параметр | Значение |
|----------|----------|
| **Смысл** | ФИО ответственного (закреплённое за оборудованием лицо). |
| **Куда грузить** | **users.full_name** (поиск или создание пользователя) → **equipment.responsible_user_id**. При наличии в ячейке `\n` (например «ФИО\n(бывш. …)») брать **первую строку** как full_name; остальное при необходимости в примечание. |
| **Особые значения** | Нет. Пустое — responsible_user_id = NULL, логировать. |
| **Примечания** | При отсутствии пользователя в БД: создать с минимальными данными (full_name) или пропустить и записать в лог — по регламенту заказчика. |

---

### Столбец 2 — Отдел

| Параметр | Значение |
|----------|----------|
| **Смысл** | В листе АРМ столбец смешанный: часть значений — **статус карточки** (подписана ли карточка на оборудовании), часть — **название подразделения**. В полном файле «Основной Учет.xlsx» (лист АРМ) встречаются оба типа. |
| **Значения-статусы (не отдел)** | «Карточка оформлена», «Карточка не нужна», «Оформить карточку», «Где мониторы?», «Временно до 31.07.2025», «МОЛ Данилкин» (может быть МОЛ), а также одиночная запятая «,» — мусор. Эти значения **не** считать отделом; статусы карточки — решение по месту хранения не принято. |
| **Значения — возможные отделы** | «Водители», «Типография», «Канцелярия», «Кадровый центр», «Организационное управление», «Компьютерный класс» и подобные — при появлении в схеме поля department и решении загружать отдел можно маппить в users.department. |
| **Куда грузить** | **Пока не загружаем** ни в department, ни в поле статуса карточки. Значения-статусы не класть в department. |
| **Лист Принтеры** | На листе «Принтеры» столбец «Отдел» содержит реальные подразделения (Типография, Канцелярия и т.д.); «Карточка оформлена» там вынесена в **отдельный столбец** (см. п. 4). |

---

### Столбец 3 — Помещение

| Параметр | Значение |
|----------|----------|
| **Смысл** | Кабинет, пост, локация (число или текст: 103, 105, 701, «Пост охраны»). |
| **Куда грузить** | **locations.name** (нормализовать к строке) → **equipment.location_id**. |
| **Особые значения** | Число (103, 105) → строка `"103"`, `"105"`. Текст «Пост охраны» — как есть. При отсутствии локации в БД — создать (location_type = «кабинет» или «другое») или логировать. |

---

### Столбец 4 — ЦП

| Параметр | Значение |
|----------|----------|
| **Смысл** | Модель процессора (одно значение; запятая в «3,3 ГГц» — десятичный разделитель). |
| **Куда грузить** | **part_char_values**: тип части «ЦП», характеристика «Модель», **value_text = значение целиком** (без разбиения по запятой). |
| **Особые значения** | Нет. Пустое — запись в part_char_values не создаём. |

---

### Столбец 5 — ОЗУ

| Параметр | Значение |
|----------|----------|
| **Смысл** | Объём оперативной памяти. |
| **Куда грузить** | **part_char_values**: тип части «ОЗУ», характеристика «Объём», value_text. |
| **Особые значения** | Нет. Пустое — не создаём запись. |

---

### Столбец 6 — Диск

| Параметр | Значение |
|----------|----------|
| **Смысл** | Накопители; возможны несколько значений в одной ячейке через `\n`. |
| **Куда грузить** | **part_char_values**: тип части «Накопитель» (или «Жесткий диск» по справочнику). При наличии `\n` — **несколько записей** (каждая подстрока = одна value_text); без `\n` — одна запись. |
| **Особые значения** | Нет. Пустое — не создаём записи. |

---

### Столбец 7 — Системный блок

| Параметр | Значение |
|----------|----------|
| **Смысл** | Модель/наименование СБ или тип техники (системный блок, моноблок, ноутбук). |
| **Куда грузить** | **equipment.name** (при необходимости конкатенация с инв. номером по регламенту), **equipment.equipment_type** (системный блок / моноблок / ноутбук — вывести из текста или справочника). |
| **Особые значения** | Пустое при строке «только монитор» — name/equipment_type брать из столбца Монитор и типа «Монитор». |

---

### Столбец 8 — Пароль на BIOS, пользов. не админ, сложный пароль

| Параметр | Значение |
|----------|----------|
| **Смысл** | Служебная пометка (XXX, XX, _X_ и т.д.). |
| **Куда грузить** | **Не загружаем.** |
| **Особые значения** | Любые — игнорируем. |

---

### Столбец 9 — № системн. блока

| Параметр | Значение |
|----------|----------|
| **Смысл** | Инвентарный номер системного блока (или пометка МЦ.04.x, текст «Электроника» и т.д.). |
| **Куда грузить** | **equipment.inventory_number** для строки-ПК. При неатомарности (`\n`) — **первая подстрока** в inventory_number; остальное при необходимости в description. |
| **Особые значения** | МЦ.04, МЦ.04.1, МЦ.04.2, «Электроника» — все как допустимые значения inventory_number (или синтетический номер по правилам МЦ.04). |

---

### Столбец 10 — Дата закупки системного блока

| Параметр | Значение |
|----------|----------|
| **Смысл** | Год, дата или текст (например, «2022 (б/у)»). |
| **Куда грузить** | **equipment.purchase_date**. Парсинг: год (число) → 01.01.YYYY; строка DD.MM.YYYY → date; иначе (текст, «2022 (б/у)») → NULL, при необходимости исходный текст в **equipment.description**. |
| **Особые значения** | «2022 (б/у)», «Информтехника» и т.п. — не парсить в дату; NULL или в description. |

---

### Столбец 11 — Монитор

| Параметр | Значение |
|----------|----------|
| **Смысл** | Модель монитора; при `\n` или `; ` — несколько мониторов в одной ячейке. |
| **Куда грузить** | По п. **1.1**: на **каждую физическую единицу** — отдельная запись **equipment** (equipment_type = «Монитор», name = модель, inventory_number = МЦ.04-mon-XXX, тот же responsible_user_id и location_id, что у строки-ПК). Дополнительно для строки-ПК — **part_char_values**: тип части «Монитор», value_text (одна или несколько записей по подстрокам — для отображения конфигурации в гриде). |
| **Разделители** | `\n`, при наличии — `; ` (например «AOC 24P2Q; AOC 24P2Q» → две записи equipment). |
| **Особые значения** | «Моноблок» при моноблоке — в part_char_values одна запись «Моноблок»; отдельную запись equipment типа «Монитор» для встроенного экрана **не** создаём. Пустое — записей не создаём. |

---

### Столбец 12 — № монитора

| Параметр | Значение |
|----------|----------|
| **Смысл** | Инв. номер монитора (или МЦ.04, НИИСУ и т.д.). При `\n` — несколько номеров. |
| **Куда грузить** | Для строки-ПК — **part_char_values**: «№ монитора», value_text (при `\n` — несколько записей). Для строки «только монитор» — **equipment.inventory_number** (первая подстрока при `\n`; при нескольких — синтетические номера для нескольких записей equipment). |

---

### Столбец 13 — Дата закупки монитора

| Параметр | Значение |
|----------|----------|
| **Смысл** | Год или дата закупки монитора; при `\n` — несколько дат. |
| **Куда грузить** | **Примечание** или **part_char_values** (характеристика «Дата закупки монитора»). Парсинг дат — по тем же правилам, что и для столбца 10. При `\n` — несколько записей или одна объединённая по регламенту. |
| **Особые значения** | Нет. |

---

### Столбец 14 — Имя

| Параметр | Значение |
|----------|----------|
| **Смысл** | Имя ПК в сети (hostname). |
| **Куда грузить** | **part_char_values**: тип части/характеристика «Имя ПК» (или «Hostname»), value_text. |
| **Особые значения** | Пустое — не создаём запись. |

---

### Столбец 15 — IP адрес

| Параметр | Значение |
|----------|----------|
| **Смысл** | IP-адрес или текст («не в сети», «DHCP (VLAN 214)»). |
| **Куда грузить** | **part_char_values**: характеристика «IP адрес», value_text (как есть). |
| **Особые значения** | «не в сети», «DHCP (VLAN 214)» — сохранять как текст, не парсить в адрес. В заголовке файла возможен пробел перед «IP» — при маппинге по имени столбца нормализовать. |

---

### Столбец 16 — ОС

| Параметр | Значение |
|----------|----------|
| **Смысл** | Операционная система. |
| **Куда грузить** | **part_char_values**: характеристика «ОС», value_text. |
| **Особые значения** | Нет. Пустое — не создаём запись. |

---

### Столбец 17 — Антивирус

| Параметр | Значение |
|----------|----------|
| **Смысл** | Наименование антивируса (KES11, KES12 и т.д.). |
| **Куда грузить** | **part_char_values**: характеристика «Антивирус», value_text. |
| **Особые значения** | Нет. Пустое — не создаём запись. |

---

### Столбец 18 — Другая техника

| Параметр | Значение |
|----------|----------|
| **Смысл** | ИБП, принтер и прочее оборудование, закреплённое за тем же пользователем. В ячейке — текст вида «ИБП &lt;марка и модель&gt;» (возможно несколько через `\n`). |
| **Куда грузить** | По п. **1.1**: подстроки, начинающиеся с «ИБП » — в **отдельные записи equipment** (equipment_type = «ИБП», name = текст после «ИБП », inventory_number = МЦ.04-ups-XXX, тот же responsible_user_id и location_id, что у строки-ПК). В **equipment.description** строки-ПК извлечённые ИБП **не** оставлять. Прочий текст (принтер, иное) — в equipment.description строки-ПК или в отдельные записи equipment по решению (принтеры при наличии листа «Принтеры» могут учитываться там). |
| **Особые значения** | Пустое — не заполняем. Несколько ИБП в одной ячейке (через `\n`) — разбивать и создавать по одной записи equipment на каждый. |

---

## 3. Файл «Основной Учет.xlsx» (полный), лист АРМ: дополнительные столбцы 19–22

В полном файле лист «АРМ» содержит **23 столбца** (в ОУ_тест — 18). Дополнительные столбцы:

| № | Заголовок | Смысл | Куда грузить / действие |
|---|-----------|--------|---------------------------|
| 19 | Сист. Блок (моноблок) в ведомости бух. | Учёт СБ в бухгалтерии: «Да (15М)», «МЦ.04», «Списано 30-12-2021» и т.д. | Решение не принято. Пока не загружаем или в equipment.description / отдельное поле при появлении в схеме. |
| 20 | Монитор в ведомости бух. | Учёт монитора в бухгалтерии: «МЦ.04», «Да (15М)» и т.д. | Аналогично столбцу 19. |
| 21 | Примечание | Свободный текст (АСТ ГОЗ, внешний SSD, софт и т.д.). | **equipment.description** (дополнять к существующему или отдельное поле при наличии). При неатомарности (`\n`) — объединять в один текст или разбивать по регламенту. |
| 22 | Для инвентаризации 2023-10 | Служебная пометка под инвентаризацию. | Пока не загружаем. |
| 23 | *(пустой заголовок)* | Часто пусто. | Игнорировать. |

**Разделители в полном файле (лист АРМ):** в столбцах Пользователь, Системный блок, № системн. блока, Монитор, № монитора, Дата закупки монитора, IP адрес, Другая техника, столбцы 19–21 встречается `\n`. В **Диск** дополнительно — **запятая** (см. п. 1 и столбец 6). Точка с запятой и « и » в данных не используются как разделители списков; « и » в тексте («Стоит VipNet и Secret Net») — часть значения.

---

## 4. Лист «Принтеры» (файл Основной Учет.xlsx)

Лист **Принтеры**: 363 строки, **13 столбцов**. Учёт принтеров/МФУ как отдельных единиц equipment (тип «Принтер» / «МФУ»).

### 4.1. Заголовки и маппинг

| № | Столбец | Смысл | Куда грузить |
|---|---------|--------|---------------|
| 1 | Пользователь | ФИО ответственного | users.full_name → equipment.responsible_user_id |
| 2 | Отдел | Подразделение (Типография, Канцелярия и т.д.) | При наличии поля department — users.department; иначе пока не загружаем |
| 3 | Помещение | Кабинет/локация | locations.name → equipment.location_id |
| 4 | Оргтехника | Наименование принтера/МФУ | equipment.name, equipment.equipment_type (Принтер/МФУ по тексту) |
| 5 | Инвент. № принтера | Инвентарный номер | equipment.inventory_number |
| 6 | Дата закупки | Дата | equipment.purchase_date (парсинг DD.MM.YYYY, год) |
| 7 | Карточка оформлена | Статус карточки (отдельный столбец на этом листе) | По решению — поле статуса карточки или не загружаем |
| 8 | IP адрес | IP или «USB» | part_char_values: IP адрес |
| 9 | Примечания | Текст | equipment.description |
| 10 | Принтер в ведомости бух. | Учёт в бух. («да (ОС)» и т.д.) | По решению (пока не загружаем или описание) |
| 11 | Сетевой пароль администратора | Служебное (в т.ч. с `\n`) | **Не загружаем** (конфиденциально или служебное) |
| 12 | Для инвентаризации 2023-10 | Служебная пометка | Не загружаем |
| 13 | Примечание | Доп. текст | Дополнять equipment.description |

### 4.2. Разделители на листе Принтеры

- **`\n`** встречается в столбцах: Пользователь, Оргтехника, Инвент. № принтера, IP адрес, Сетевой пароль администратора, Принтер в ведомости бух. Для Пользователь — первая строка как full_name; для пароля — не загружаем; для остальных — по контексту (одна запись или разбиение).
- **Запятая** — в названиях оргтехники (модель, скобки с параметрами), в примечаниях; не трактовать как разделитель списков для загрузки в отдельные записи, хранить как единое значение.

### 4.3. Семантика

Одна строка листа Принтеры = одна запись **equipment** (equipment_type = «Принтер» или «МФУ»), inventory_number из столбца 5, при отсутствии — синтетический или МЦ.04 по регламенту.

---

## 5. Сводная таблица «столбец → действие» (лист АРМ, столбцы 1–18)

| № | Столбец | Куда грузить | Не загружаем / особо |
|---|---------|---------------|------------------------|
| 1 | Пользователь | users.full_name → equipment.responsible_user_id | |
| 2 | Отдел | **Пока не загружаем** (статус «карточка оформлена», не отдел; решение по месту хранения не принято) | Не в department |
| 3 | Помещение | locations.name → equipment.location_id | |
| 4 | ЦП | part_char_values: ЦП, «Модель», value_text целиком | Запятая не разделитель |
| 5 | ОЗУ | part_char_values: ОЗУ, «Объём» | |
| 6 | Диск | part_char_values: Накопитель; при `\n` и **запятой** (полный файл) — несколько записей | Только для Диск: запятая — разделитель |
| 7 | Системный блок | equipment.name, equipment.equipment_type | |
| 8 | Пароль на BIOS… | — | **Не загружаем** |
| 9 | № системн. блока | equipment.inventory_number (при `\n` — первая подстрока) | |
| 10 | Дата закупки системного блока | equipment.purchase_date (год/дата/текст по правилам) | |
| 11 | Монитор | part_char_values: Монитор; при `\n` — несколько записей | |
| 12 | № монитора | part_char_values или equipment.inventory_number (строка «только монитор») | |
| 13 | Дата закупки монитора | примечание / part_char_values | |
| 14 | Имя | part_char_values: Имя ПК (hostname) | |
| 15 | IP адрес | part_char_values: IP адрес | |
| 16 | ОС | part_char_values: ОС | |
| 17 | Антивирус | part_char_values: Антивирус | |
| 18 | Другая техника | equipment.description или отдельный equipment | |

---

## 6. Открытые вопросы и решения

Вносить сюда пункты, по которым решение ещё не принято; после принятия — переносить в п. 2 и сводную таблицу.

| Вопрос | Текущее состояние | Ответственный |
|--------|-------------------|---------------|
| Куда хранить статус «Карточка оформлена» (подписана ли карточка на оборудовании)? | Не загружаем; поле users.department не использовать для этого значения. | Уточнить с заказчиком: отдельное поле equipment, справочник, описание. |
| Будет ли в схеме поле department у пользователя и откуда его заполнять? | Не определено. | Уточнить с заказчиком. |
| «Другая техника» (ИБП и т.д.) — только description или отдельные записи equipment? | **Решено:** ИБП — отдельные записи equipment (тип «ИБП», name = марка и модель после «ИБП », inv. МЦ.04-ups-XXX). См. п. 1.1 и столбец 18. | Зафиксировано в п. 1.1, столбцы 11 и 18. |

---

## 7. Связь с другими документами

- **Реализация парсера/загрузчика:** использовать только данный регламент для маппинга столбцов и особых значений.
- **Примеры разбора:** `docs/ОУ_ТЕСТ_ПЕРВЫЕ_10_СТРОК_ПАРСИНГ.md` — приведение к атомарным значениям и примеры; при расхождении с регламентом приоритет у **настоящего документа**.
- **ETL и инструменты:** `docs/ОУ_ТЕСТ_ПАРСИНГ_ETL_И_ИНСТРУМЕНТЫ.md` — общая схема ETL; маппинг столбцов брать из регламента.

При изменении правил парсинга или появлении новых особых значений — обновлять в первую очередь **РЕГЛАМЕНТ_ПАРСИНГА_ОУ_ТЕСТ.md**, затем при необходимости примеры и ETL-документ.

---

## Краткая сводка: что добавлено по полному «Основной Учет.xlsx»

| Тема | Где в регламенте | Суть |
|------|-------------------|------|
| Разделитель **запятая** | п. 1, столбец 6 (Диск) | В столбце Диск (лист АРМ) разбивать по `\n` **и по запятой** («SSD 240 ГБ, 1 ТБ» → две записи). В ЦП запятая — десятичный разделитель, не разбивать. |
| **Отдел**: статусы vs отделы | Столбец 2 | Список значений-статусов (Карточка оформлена, Оформить карточку, …) — не отдел; значения типа Типография, Канцелярия — возможный department при появлении поля. |
| **Пользователь** с `\n` | Столбец 1 | При «ФИО\n(бывш. …)» брать первую строку как full_name. |
| Доп. столбцы АРМ 19–22 | п. 3 | Сист. блок/монитор в ведомости бух., Примечание, инвентаризация — правила загрузки или «пока не загружаем». |
| Лист **Принтеры** | п. 4 | 13 столбцов, маппинг в equipment (Принтер/МФУ), столбец «Карточка оформлена» отдельно; пароль администратора не загружаем. |
| **Мониторы и ИБП: 1 запись = 1 актив** | п. 1.1, столбцы 11 и 18 | Из столбца «Монитор» — по одной записи equipment (тип «Монитор») на каждую единицу (разделители `\n`, `; `); из «Другая техника» подстроки «ИБП …» — по одной записи equipment (тип «ИБП»). Инв. номера МЦ.04-mon-XXX, МЦ.04-ups-XXX. См. docs/sistema/УТОЧНЕНИЕ_УЧЕТ_МОНИТОРЫ_ИБП_МЦ04.md. |
