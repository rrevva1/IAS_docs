# Сравнение БД: дамп (папка db) и рабочая машина

Цель: **идентичные схемы БД на домашней и рабочей машинах.**

---

## 1. Источники

| Окружение | Описание |
|-----------|----------|
| **Дамп** | Файл `db/ias_vniic_14_02_26.sql` (домашняя машина, PostgreSQL 17.4, схема `tech_accounting`). |
| **Рабочая БД** | База `ias_vniic` на этой машине после применения миграций Yii2, в т.ч. `m260215_100000_equipment_types`. |

---

## 2. Различия (дамп vs рабочая БД)

### 2.1. Таблицы

| Аспект | В дампе | На рабочей машине |
|--------|---------|---------------------|
| **equipment_types** | Нет | Есть (создана миграцией m260215). Справочник типов оборудования. |
| **equipment_software** | Есть | Есть (та же таблица, приложение использует её). |
| **software_installs** | Нет | Нет (в этом проекте используется **equipment_software**, не software_installs). |

### 2.2. Таблица equipment

| Поле | В дампе | На рабочей машине |
|------|---------|---------------------|
| Тип оборудования | **equipment_type** (varchar(100)) — текст | **equipment_type_id** (bigint) — ссылка на `equipment_types.id` |

На рабочей машине миграция m260215 перенесла уникальные значения `equipment_type` в справочник `equipment_types` и заменила столбец на `equipment_type_id`.

### 2.3. Таблицы software, licenses, equipment_software

В дампе и в миграции `m260213_120000_add_software_licenses` совпадают по названиям таблиц и по смыслу. Отличия только по типам времени (в дампе у части полей `timestamp without time zone`, на рабочей — `timestamptz` после миграций). Для работы приложения это не критично.

---

## 3. Нужно ли приводить к дампу?

**Нет.** Приводить нужно **к рабочей (текущей) схеме**, а не к дампу.

Причины:

1. **Приложение рассчитано на текущую схему:** модель `EquipmentTypes`, связь `equipment_type_id` в `Equipment`, таблица `equipment_software` (как в дампе). Без `equipment_types` и `equipment_type_id` раздел АРМ и другие места падают с ошибкой «relation "equipment_types" does not exist».
2. **Нормализованная модель:** справочник типов оборудования и FK удобнее, чем произвольный текст в столбце.
3. Документ `СРАВНЕНИЕ_ДАМП_И_БД.md` (раздел 6.5) также рекомендует эталоном считать текущую БД проекта.

**Итог:** за эталон принимаем схему **на рабочей машине**; домашнюю машину (после восстановления из дампа) приводим к ней.

---

## 4. Как сделать БД идентичными

### На рабочей машине

Ничего не менять. Схема уже соответствует приложению (миграции применены, в т.ч. m260215).

### На домашней машине (или после восстановления из дампа)

1. Восстановить БД из дампа:
   ```bash
   psql -U postgres -d postgres -c "CREATE DATABASE ias_vniic WITH ENCODING 'UTF8' TEMPLATE template0;"
   psql -U postgres -d ias_vniic -f db/ias_vniic_14_02_26.sql
   ```
2. Применить миграцию, которая добавляет `equipment_types` и переводит `equipment` на `equipment_type_id`:
   ```bash
   cd ias_uch_vnii
   YII_ENV=prod php yii migrate --migrationPath=@app/migrations --interactive=0
   ```
   Будет применена миграция **m260215_100000_equipment_types**: создаётся таблица `equipment_types`, данные из `equipment.equipment_type` переносятся в справочник, в `equipment` добавляется `equipment_type_id`, старый столбец `equipment_type` удаляется.

После этого схема на домашней машине совпадёт с рабочей по таблицам и ключевым полям (equipment_types, equipment_type_id, equipment_software и т.д.).

### Однократная проверка идентичности схем

На обеих машинах выгрузить только структуру и сравнить:

```bash
PGPASSWORD=... pg_dump -U postgres -h localhost -d ias_vniic --schema=tech_accounting --schema-only --no-owner --no-privileges -f schema_$(hostname).sql
diff schema_work.sql schema_home.sql
```

---

## 5. Краткая сводка

| Вопрос | Ответ |
|--------|--------|
| В чём разница? | В дампе: нет `equipment_types`, в `equipment` — текст `equipment_type`. На рабочей: есть `equipment_types` и `equipment_type_id`. |
| Приводить к дампу? | Нет. Приложение требует текущую схему (equipment_types). |
| К чему приводить? | К схеме на **рабочей** машине. |
| Как выровнять дом? | Восстановить дамп → запустить миграции Yii2 (в т.ч. m260215). |
| Идентичные БД? | Да: дом = восстановленный дамп + миграции; раб = уже с миграциями. |

Дополнительно: полное сравнение дампа и эталона (в т.ч. software/licenses) — в документе `СРАВНЕНИЕ_ДАМП_И_БД.md`.
