# Сравнение дампа и БД (СРАВНЕНИЕ_ДАМП_И_БД)

В документе сравниваются **только** дамп с домашней машины (`ias_vniic_14_02_26.sql`) и **текущая БД проекта** на этой машине (`ias_vniic`). Другие дампы не рассматриваются. **Полноценнее текущая БД проекта;** для единого вида окружения приводят к ней (правки — на стороне дампа/домашней машины, см. п. 6.5 и 6.6).

---

Сравнение выполнено между:
- **Дамп:** `ias_vniic_14_02_26.sql` (с домашней машины, PostgreSQL 17.4, схема `tech_accounting`).
- **Эталон проекта:** `scripts/create_ias_vniic.sql` + миграция Yii2 `ias_uch_vnii/migrations/m260213_120000_add_software_licenses.php`.

**Фактическая БД проекта на этой машине:** `ias_vniic` (localhost:5432, схема `tech_accounting`) — см. раздел 6. Ниже также отличия «дамп vs эталон» (разделы 1–5).

---

## 1. Таблицы: только в дампе (есть в дампе, нет в create_ias_vniic.sql)

Эти таблицы добавляются миграцией Yii2 и создаются при `php yii migrate`; в базовом скрипте `create_ias_vniic.sql` их нет.

| Таблица | Назначение |
|--------|------------|
| **software** | Справочник ПО (name, version, created_at). |
| **licenses** | Лицензии (software_id, valid_until, notes, created_at). |
| **equipment_software** | Связь оборудование ↔ установленное ПО. |
| **migration** | Журнал применённых миграций Yii2 (version, apply_time). |

**Вывод:** Если текущая БД разворачивалась только из `create_ias_vniic.sql` без запуска миграций Yii2, в ней **не будет** этих четырёх таблиц. После применения миграции `m260213_120000_add_software_licenses` структура по этим сущностям совпадёт с дампом.

---

## 2. Таблицы: только в эталоне (в скрипте, но не как отдельные CREATE в дампе)

Все таблицы из `create_ias_vniic.sql` присутствуют в дампе. Отдельных таблиц, которые есть только в эталоне и нет в дампе, **нет**.

---

## 3. Отличия в типах данных и ограничениях

### 3.1. Время: timestamp with time zone vs timestamp(0) without time zone

В дампе у таблиц, созданных миграцией Yii2, поля `created_at` имеют тип **timestamp(0) without time zone** (локальное время без пояса):

| Таблица | Поле | В дампе | В эталоне (миграция Yii) |
|--------|------|---------|---------------------------|
| software | created_at | `timestamp(0) without time zone` | `timestamp` (Yii → без time zone) |
| licenses | created_at | `timestamp(0) without time zone` | то же |
| equipment_software | created_at | `timestamp(0) without time zone` | то же |

В `create_ias_vniic.sql` для остальных таблиц используется **TIMESTAMPTZ** (timestamp with time zone). Для приложения разница обычно некритична (чтение/запись дат работают), но для единообразия при желании можно в миграции явно задать `timestamp with time zone`.

### 3.2. Остальные таблицы

- **equip_history:** в дампе и в скрипте — `old_value`, `new_value` типа **jsonb**. Совпадает.
- **task_history:** в дампе и в скрипте — `old_value`, `new_value` типа **text**. Совпадает.
- **nsi_change_log:** в дампе и в скрипте — `old_value`, `new_value` **jsonb**. Совпадает.
- **roles.role_name:** в дампе `varchar(150)`, в скрипте `VARCHAR(150)` — совпадает.
- **locations.name:** в дампе и в скрипте — UNIQUE, совпадает.
- **Справочники (dic_equipment_status, dic_task_status):** в дампе есть UNIQUE по `status_code` и `status_name` — как в скрипте.

Существенных расхождений по ограничениям и типам между дампом и эталоном (скрипт + миграция) не выявлено.

---

## 4. Как сравнить дамп с вашей текущей БД

Чтобы увидеть отличия именно **текущей БД** от дампа, нужно выгрузить схему текущей БД и сравнить.

### Вариант A: выгрузка только структуры текущей БД (pg_dump)

Если в PATH есть `pg_dump` и `psql`:

```bash
set PGPASSWORD=12345
pg_dump -U postgres -h localhost -p 5432 -d ias_vniic --schema=tech_accounting --schema-only --no-owner --no-privileges > current_db_schema.sql
```

Дальше можно сравнить `current_db_schema.sql` и структуру из дампа (например, вырезать из `ias_vniic_14_02_26.sql` блоки CREATE TABLE / INDEX / TRIGGER и т.д. и diff’ить).

### Вариант B: список таблиц и столбцов через psql

Скрипт `scripts/export_current_schema_for_compare.sql` (см. ниже) выводит список таблиц и столбцов текущей БД. Запуск:

```bash
set PGPASSWORD=12345
psql -U postgres -h localhost -p 5432 -d ias_vniic -f scripts/export_current_schema_for_compare.sql -o current_schema.txt
```

По `current_schema.txt` можно проверить наличие таблиц `software`, `licenses`, `equipment_software`, `migration` и набор столбцов.

---

## 5. Краткая сводка отличий «дамп vs эталон»

| Категория | Результат |
|-----------|-----------|
| Таблицы только в дампе (нет в create_ias_vniic) | **software**, **licenses**, **equipment_software**, **migration** (появляются после миграции Yii2). |
| Таблицы только в эталоне | Нет. |
| Отличия по типам | В дампе у **software**, **licenses**, **equipment_software** поле `created_at` — **timestamp(0) without time zone**; в остальных таблицах в дампе и в скрипте — **timestamptz**. |
| Ограничения (UNIQUE, CHECK, FK) | Совпадают с эталоном. |
| Триггеры | В дампе те же, что в скрипте (в т.ч. `trg_audit_events_immutable`, `set_updated_at` на нужных таблицах). |

**Рекомендация:** Чтобы текущая БД соответствовала дампу по структуре, необходимо применить миграцию `m260213_120000_add_software_licenses` (если ещё не применена). Если таблицы `software`/`licenses` уже есть (например, после предыдущей миграции), повторный запуск миграции приведёт к ошибке «отношение уже существует» — тогда структура уже совпадает с дампом по этим сущностям.

---

## 6. Фактическая БД проекта (эта машина) vs дамп с домашней машины

Сравнение выполнено по выгрузке схемы текущей БД `ias_vniic` (pg_dump --schema-only → `current_db_schema.sql`) и файлу дампа `ias_vniic_14_02_26.sql`. Источники: **эта машина** — БД, с которой работает проект (`ias_uch_vnii/config/db.php` → `ias_vniic`); **домашняя машина** — дамп от 14.02.2026.

### 6.1. Таблицы: только в текущей БД (эта машина), нет в дампе

| Таблица | Назначение |
|--------|------------|
| **equipment_types** | Справочник типов оборудования (id, name, sort_order, is_archived, created_at, updated_at). |
| **software_installs** | Связь оборудование ↔ установленное ПО (id, equipment_id, software_id, installed_at, notes, created_at). |

### 6.2. Таблицы: только в дампе (домашняя машина), нет в текущей БД

| Таблица | Назначение |
|--------|------------|
| **equipment_software** | Связь оборудование ↔ ПО в дампе (id, equipment_id, software_id, installed_at, created_at). По смыслу соответствует **software_installs**, но другое имя таблицы и в дампе нет поля `notes`. |

### 6.3. Отличия в структуре общих таблиц

| Таблица | В дампе (домашняя) | В текущей БД (эта машина) |
|--------|----------------------|----------------------------|
| **equipment** | Поле `equipment_type` (varchar(100)) — тип оборудования текстом. | Поле `equipment_type_id` (bigint) — ссылка на справочник **equipment_types**. |
| **software** | id, name, version, created_at (timestamp without time zone). | Дополнительно: license_keys, description, is_archived, updated_at; CHECK chk_software_name_not_empty; created_at — timestamptz. |
| **licenses** | id, software_id, valid_until (nullable), notes, created_at (timestamp without time zone). | Дополнительно: valid_from, license_key; valid_until NOT NULL; updated_at; created_at — timestamptz. |
| **locations** | Совпадает (chk_location_type, chk_locations_name_not_empty). | Совпадает. |

### 6.4. Сводка

| Категория | Результат |
|-----------|-----------|
| Таблицы только в текущей БД | **equipment_types**, **software_installs**. |
| Таблицы только в дампе | **equipment_software**. |
| Тип оборудования | Дамп: текст в **equipment.equipment_type**. Текущая БД: справочник **equipment_types** и **equipment.equipment_type_id**. |
| Связь оборудование–ПО | Дамп: **equipment_software**. Текущая БД: **software_installs** (есть поле notes). |
| Расширения в текущей БД | В **software**: license_keys, description, is_archived, updated_at, CHECK. В **licenses**: valid_from, license_key, valid_until NOT NULL, updated_at. |
| Типы времени | В дампе у software/licenses/equipment_software — timestamp without time zone; в текущей БД — timestamptz где применимо. |

**Итог:** фактическая БД проекта на этой машине **не совпадает** с дампом с домашней машины: другая модель типа оборудования (справочник vs текст), другое имя таблицы связи с ПО (software_installs vs equipment_software) и расширенная структура таблиц **software** и **licenses**.

### 6.5. Какая БД полноценнее

**Полноценнее текущая БД проекта (эта машина).**

| Критерий | Дамп (домашняя) | Текущая БД (эта машина) |
|----------|------------------|--------------------------|
| Тип оборудования | Текст в столбце — нет справочника, нет единообразия. | Справочник **equipment_types** + FK по смыслу — нормализованная модель. |
| Связь оборудование–ПО | Таблица **equipment_software** без поля для заметок. | Таблица **software_installs** с полем **notes**. |
| Справочник ПО | Только name, version, created_at. | Дополнительно: license_keys, description, is_archived, updated_at, CHECK по имени. |
| Лицензии | valid_until (nullable), notes, created_at. | valid_from, license_key, **valid_until NOT NULL**, updated_at — пригоднее для учёта. |
| Время | timestamp without time zone в ПО/лицензиях. | timestamptz — единообразие с остальной схемой. |

Вывод: текущая БД даёт нормализованный тип оборудования, расширенный учёт ПО и лицензий и единый подход к датам; приводить общий вид нужно **к текущей БД**.

### 6.6. Что поправить, чтобы вид был один (приведение к текущей БД)

Приведение делается **на стороне дампа / домашней машины**: либо правят восстановленную из дампа БД (миграциями или SQL), либо обновляют скрипты развёртывания под текущую схему. Текущую БД на этой машине **не меняем**.

| Где править (дамп/домашняя БД) | Что сделать |
|---------------------------------|-------------|
| **1. Справочник типов оборудования** | Создать таблицу **equipment_types** (id, name, sort_order, is_archived, created_at, updated_at), последовательность, CHECK `chk_equipment_types_name_not_empty`. В **equipment**: удалить столбец `equipment_type` (varchar), добавить `equipment_type_id bigint`. При наличии данных: заполнить `equipment_types` из уникальных значений `equipment.equipment_type`, обновить `equipment_type_id`, затем удалить `equipment_type`. |
| **2. Таблица связи оборудование–ПО** | Переименовать **equipment_software** → **software_installs** (или создать **software_installs** и перенести данные). Добавить столбец **notes** (text). Поле created_at привести к типу **timestamp with time zone**. |
| **3. Таблица software** | Добавить столбцы: **license_keys** (text), **description** (text), **is_archived** (boolean DEFAULT false NOT NULL), **updated_at** (timestamptz DEFAULT CURRENT_TIMESTAMP NOT NULL). Поле **created_at** изменить на **timestamp with time zone**. Добавить ограничение **chk_software_name_not_empty** (length(trim(name)) > 0). |
| **4. Таблица licenses** | Добавить столбцы: **valid_from** (date), **license_key** (varchar(255)). Сделать **valid_until NOT NULL** (для существующих NULL задать значение, например valid_from или дату по умолчанию). Добавить **updated_at** (timestamptz DEFAULT CURRENT_TIMESTAMP NOT NULL). Поле **created_at** изменить на **timestamp with time zone**. |

**Порядок на домашней машине (или при восстановлении из дампа):**  
1) Создать `equipment_types`, перенести данные из `equipment.equipment_type`, перейти на `equipment_type_id` и удалить `equipment_type`.  
2) Переименовать/заменить `equipment_software` на `software_installs`, добавить `notes` и поправить тип `created_at`.  
3) Расширить `software` и `licenses` по таблице выше.  

После этого схема на домашней машине будет соответствовать текущей БД проекта; для повторяемого развёртывания эти шаги стоит оформить миграцией Yii2 или отдельным SQL-скриптом.
