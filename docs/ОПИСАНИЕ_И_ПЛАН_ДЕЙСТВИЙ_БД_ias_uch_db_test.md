# Описание и план действий по БД ias_uch_db_test

Документ содержит: предложения по изменениям и дополнениям схемы под ТЗ; оценку состояния БД; проверку корректности и понятности имён таблиц и полей; план действий по приведению БД к работе.

**Источники:** `TZ.md`, `scripts/create_ias_uch_db_test.sql`, `docs/МОДЕЛЬ_БД_ias_uch_db_test.md`.

---

## 1. Изменения и дополнения под ТЗ

### 1.1. Обязательные дополнения (в объёме ТЗ)

#### 1.1.1. Контур учёта ПО и лицензий (ТЗ 5.1.12, п. 1.4.6)

Контур «ПО и лицензии» входит в состав Системы и в объём работ по ТЗ. В текущей схеме `ias_uch_db_test` таблиц для него **нет**.

**Рекомендуемые таблицы:**

| Таблица | Назначение | Ключевые поля |
|--------|------------|----------------|
| **software** | Справочник ПО | id, name, version, vendor, description, is_archived, created_at, updated_at |
| **licenses** | Лицензии | id, software_id (FK), license_key, valid_from, valid_to, seats, comment, created_at |
| **software_installs** | Связь «актив — установленное ПО» | id, equipment_id (FK), software_id (FK), license_id (FK, nullable), version_installed, installed_at, installed_by_id (FK→users) |

Дополнительно: индексы по software_id, valid_to (для отчётов по истекающим лицензиям), (equipment_id, software_id). Аудит операций с этими сущностями уже покрывается таблицей `audit_events`.

#### 1.1.2. Комментарии по заявке с фиксацией автора и даты (ТЗ 5.1.3.4)

ТЗ требует ведение **комментариев** (множество) по заявке с фиксацией **автора** и **даты/времени**. Сейчас в таблице `tasks` есть одно поле `comment` (текст), что не позволяет хранить историю комментариев и авторов.

**Рекомендуемое дополнение:**

| Таблица | Назначение | Ключевые поля |
|--------|------------|----------------|
| **task_comments** | Комментарии к заявке | id, task_id (FK), author_id (FK→users), comment_text (TEXT), created_at (TIMESTAMPTZ), is_internal (BOOLEAN, опционально) |

Поле `tasks.comment` оставить для обратной совместимости или краткого «итогового» комментария; основное хранение комментариев — в `task_comments`.

### 1.2. Рекомендуемые уточнения (по ТЗ и практике)

#### 1.2.1. Карточка актива: марка и модель (ТЗ 5.1.5.3)

В ТЗ в рекомендуемый состав атрибутов входят **марка** и **модель**. В `equipment` есть `name` и `equipment_type` (тип техники), отдельных полей «марка»/«модель» нет.

**Рекомендация:** добавить в таблицу `equipment` необязательные поля:

- **brand** VARCHAR(100) — марка;
- **model** VARCHAR(150) — модель.

Либо зафиксировать в проектной документации, что марка/модель хранятся в `name` или в `part_char_values` (например, тип части «Системный блок», характеристика «Модель»).

#### 1.2.2. Ремонты и обслуживание — дополнительные сведения (ТЗ 5.1.5.8)

ТЗ допускает хранение для ремонтов/обслуживания: дата, стоимость, подрядчик, описание. В схеме есть `equip_history` с `event_type` ('maintenance' и др.) и JSONB `old_value`/`new_value`, куда можно класть структуру `{ "cost": ..., "contractor": ..., "description": ... }`.

**Рекомендация:** текущей схемы достаточно; при необходимости ввести справочник типов событий или отдельную таблицу `maintenance_events` — на этапе обследования.

#### 1.2.3. Идемпотентность импорта (ТЗ 5.1.11.4)

ТЗ требует возможность повторного выполнения импорта без нарушения целостности. В схеме есть `import_runs` и `import_errors`; правила идемпотентности (например, ключи уникальности по бизнес-полям, «update or insert» по инв. номеру) реализуются в коде импорта и фиксируются в проектной документации. Изменений в DDL не требуется.

### 1.3. Сводка по изменениям DDL

| Изменение | Приоритет | Действие |
|-----------|-----------|----------|
| Таблицы software, licenses, software_installs | Обязательно (ТЗ 5.1.12) | Добавить в `create_ias_uch_db_test.sql` |
| Таблица task_comments | Обязательно (ТЗ 5.1.3.4) | Добавить в скрипт |
| Поля equipment.brand, equipment.model | Рекомендуется | Добавить или зафиксировать отказ в документации |
| Триггеры updated_at для новых таблиц | Рекомендуется | Добавить для software, licenses при наличии updated_at |

---

## 2. Оценка состояния БД

### 2.1. Полнота относительно ТЗ

| Раздел ТЗ | Требование | Состояние в ias_uch_db_test |
|-----------|------------|-----------------------------|
| 5.1.1 | Пользователи, роли, доступ | Реализовано: users, roles, permissions, user_roles, role_permissions. Блокировка (is_locked, failed_login_attempts, lock_until) есть. |
| 5.1.2 | НСИ, история изменений справочников | Реализовано: справочники с is_archived; nsi_change_log для истории изменений. |
| 5.1.3 | Help Desk (заявки) | Реализовано: tasks, task_history, dic_task_status. **Нет отдельной таблицы комментариев** (см. п. 1.1.2). |
| 5.1.4 | Вложения | Реализовано: desk_attachments, task_attachments, метаданные (размер, тип, загрузивший, дата). |
| 5.1.5 | Учёт активов | Реализовано: equipment (инв. номер, серийный номер, статус, локация, ответственный, даты, поставщик), equip_history, part_char_values, архивирование. |
| 5.1.6 | Связь заявок с активами | Реализовано: task_equipment (M:N). |
| 5.1.8 | Поиск и фильтрация | Поддерживается индексами по инв. номеру, серийному номеру, name, статусу, локации, ответственному. |
| 5.1.10 | Аудит | Реализовано: audit_events, триггер неизменяемости. |
| 5.1.11 | Импорт | Реализовано: import_runs, import_errors. |
| 5.1.12 | ПО и лицензии | **Не реализовано** — таблиц нет (см. п. 1.1.1). |

### 2.2. Целостность и согласованность

- Первичные и внешние ключи заданы, ссылочная целостность обеспечивается.
- Ограничения CHECK заданы для перечислений (статусы, типы локаций, приоритеты, result_status аудита и т.д.).
- Уникальность: inventory_number (equipment), serial_number (equipment, где не NULL), пары (task_id, equipment_id), (task_id, attachment_id) и др.
- Триггеры: обновление `updated_at` на основных таблицах; запрет UPDATE/DELETE для `audit_events`.

### 2.3. Готовность к развёртыванию

| Критерий | Оценка |
|----------|--------|
| Схема создаётся одним скриптом | Да, с BEGIN/COMMIT. |
| Базовое наполнение справочников | Да: roles, dic_task_status, dic_equipment_status (INSERT … ON CONFLICT DO NOTHING). |
| Начальные данные пользователей | Нет — первого администратора нужно создавать вручную или миграцией. |
| Зависимости (расширения PostgreSQL) | Только стандартные типы (JSONB, INET, TIMESTAMPTZ). |
| Версия PostgreSQL | Код рассчитан на современные версии (IDENTITY, GENERATED); целесообразно 12+. |

**Итог:** состояние БД оценивается как **хорошее для запуска** после внесения обязательных дополнений: контур ПО и лицензий (таблицы software, licenses, software_installs) и таблица комментариев к заявкам (task_comments). Остальная схема соответствует ТЗ и готова к использованию.

---

## 3. Корректность и понятность имён таблиц и полей

### 3.1. Именование таблиц

| Таблица | Оценка | Пояснение |
|---------|--------|-----------|
| roles, users, permissions, user_roles, role_permissions | Корректно | Понятные английские имена в контексте RBAC. |
| locations | Корректно | Места размещения (кабинеты, склады и т.д.). |
| dic_equipment_status, dic_task_status | Корректно | Префикс dic_ = справочник (dictionary); понятно для русскоязычной команды. |
| spr_parts, spr_chars | Корректно | spr_ = справочник (справочник типов частей, справочник характеристик); устоявшееся в проекте. |
| nsi_change_log | Корректно | НСИ = нормативно-справочная информация; лог изменений НСИ. |
| equipment | Корректно | Оборудование / активы. |
| equip_history | Корректно | История событий по оборудованию. |
| part_char_values | Корректно | Значения характеристик (char) по типам частей (part) для оборудования. |
| tasks | Корректно | Заявки Help Desk. |
| task_history | Корректно | История изменений заявки. |
| task_equipment | Корректно | Связь заявка–оборудование (M:N). |
| desk_attachments | Приемлемо | «Desk» = helpdesk; вложения (файлы). Чтобы избежать путаницы с task_attachments (связь), в документации явно указать: desk_attachments = хранилище файлов, task_attachments = связь заявка–вложение. |
| task_attachments | Корректно | Связь «заявка – вложение». |
| audit_events | Корректно | События аудита. |
| import_runs, import_errors | Корректно | Протоколы импорта. |

Рекомендация: для `desk_attachments` добавить в описание модели и в комментарии к таблице пояснение: «Файлы, загруженные в систему (в т.ч. к заявкам). Связь с заявками — через task_attachments».

### 3.2. Оценка названий полей по таблицам

Ниже — потабличная оценка: **OK** (понятно и уместно), **Прим.** (приемлемо, желательно пояснение в документации), **Рек.** (рекомендуется уточнить или переименовать).

#### roles
| Поле | Оценка | Комментарий |
|------|--------|-------------|
| id | OK | Стандартный PK. |
| role_code | OK | Код роли для программной привязки (уникальный). |
| role_name | OK | Человекочитаемое название. |
| description | OK | Описание роли. |
| is_system | OK | Системная роль (не удаляемая). |
| is_archived | OK | Исключена из выбора без потери ссылок. |
| created_at, updated_at | OK | Единый стиль _at для времени. |

#### permissions
| Поле | Оценка | Комментарий |
|------|--------|-------------|
| id | OK | PK. |
| perm_code | OK | Код права (уникальный). |
| perm_name | OK | Наименование права. |
| description | OK | Описание. |
| created_at | OK | Метка создания. |

#### users
| Поле | Оценка | Комментарий |
|------|--------|-------------|
| id | OK | PK. |
| username | OK | Логин (уникальный). |
| full_name | OK | ФИО. |
| position | OK | Должность. |
| department | OK | Подразделение. |
| email, phone | OK | Контакты. |
| password_hash | OK | Явно указано, что хранится хэш. |
| is_active | OK | Активность учётной записи. |
| is_locked | OK | Временная блокировка. |
| failed_login_attempts | OK | Счётчик неудачных попыток входа. |
| lock_until | OK | До какого момента заблокирован. |
| password_changed_at | OK | Дата смены пароля (для политики паролей). |
| last_login_at | OK | Последний вход. |
| created_by_id, updated_by_id | OK | Аудит: кто создал/обновил. |
| created_at, updated_at | OK | Временные метки. |
| is_deleted | OK | Мягкое удаление. |

#### user_roles
| Поле | Оценка | Комментарий |
|------|--------|-------------|
| user_id, role_id | OK | FK, суффикс _id. |
| assigned_by | OK | Кто назначил роль. |
| assigned_at, revoked_at | OK | Когда назначено/отозвано. |
| is_active | OK | Активно ли назначение (при отзыве — false или отдельная запись). |

#### role_permissions
| Поле | Оценка | Комментарий |
|------|--------|-------------|
| role_id, permission_id | OK | FK. |
| granted_by, granted_at | OK | Кто и когда выдал право. |

#### locations
| Поле | Оценка | Комментарий |
|------|--------|-------------|
| id | OK | PK. |
| location_code | OK | Код помещения (опционально). |
| name | OK | Название (кабинет, склад и т.д.). |
| location_type | OK | Тип из ограниченного набора (CHECK). |
| floor | OK | Этаж. |
| description | OK | Описание. |
| is_archived | OK | Архив без удаления. |
| created_by_id, updated_by_id, created_at, updated_at | OK | Аудит. |

#### dic_equipment_status, dic_task_status
| Поле | Оценка | Комментарий |
|------|--------|-------------|
| id | OK | PK. |
| status_code | OK | Код для кода/API. |
| status_name | OK | Название для отображения. |
| sort_order | OK | Порядок вывода в списках. |
| is_final | OK | Финальный статус (заявка/оборудование «закрыты»). |
| is_archived | OK | Скрыт из выбора без потери ссылок. |
| created_at, updated_at | OK | Метки времени. |

#### spr_parts, spr_chars
| Поле | Оценка | Комментарий |
|------|--------|-------------|
| id, name, description | OK | Стандартные поля справочника. |
| measurement_unit | OK | Только в spr_chars — единица измерения (ГБ, ГГц и т.д.). |
| is_archived, created_at, updated_at | OK | Архив и аудит. |

#### nsi_change_log
| Поле | Оценка | Комментарий |
|------|--------|-------------|
| dictionary_name | OK | Имя справочника (таблицы). |
| record_id | OK | ID записи в справочнике. |
| operation_type | OK | insert/update/archive/restore/delete. |
| old_value, new_value | OK | JSONB — состав изменения. |
| changed_by, changed_at | OK | Кто и когда изменил. |

#### equipment
| Поле | Оценка | Комментарий |
|------|--------|-------------|
| id | OK | PK. |
| inventory_number | OK | Инвентарный номер (уникальный). |
| serial_number | OK | Серийный номер. |
| name | OK | Наименование/обозначение актива. |
| equipment_type | OK | Тип техники (системный блок, ноутбук и т.д.). |
| status_id | OK | FK на справочник статусов. |
| responsible_user_id | OK | Ответственный (закреплённое лицо). |
| location_id | OK | Место размещения. |
| supplier | OK | Поставщик. |
| purchase_date | OK | Дата приобретения. |
| commissioning_date | OK | Дата ввода в эксплуатацию. |
| warranty_until | OK | Гарантия до (даты). |
| description | OK | Примечание. |
| archived_at, archive_reason | OK | Когда и почему переведён в архив. |
| is_archived, is_deleted | OK | Флаги состояния. |
| created_by_id, updated_by_id, created_at, updated_at | OK | Аудит. |

#### equip_history
| Поле | Оценка | Комментарий |
|------|--------|-------------|
| equipment_id | OK | FK на оборудование. |
| event_type | OK | Тип события (create, move, assign, maintenance, writeoff и т.д.). |
| old_value, new_value | OK | JSONB — содержание изменения. |
| changed_by, changed_at | OK | Кто и когда. |
| comment | OK | Текстовый комментарий к событию. |

#### part_char_values
| Поле | Оценка | Комментарий |
|------|--------|-------------|
| equipment_id, part_id, char_id | OK | FK: оборудование, тип части, характеристика. |
| value_text, value_num | OK | Текстовое и числовое значение. |
| source | Прим. | Источник значения (manual, import и т.д.) — стоит описать допустимые значения в документации. |
| updated_by, updated_at | OK | Кто и когда обновил. |

#### tasks
| Поле | Оценка | Комментарий |
|------|--------|-------------|
| id | OK | PK. |
| task_number | OK | Уникальный номер заявки (для отображения). |
| title | OK | Краткий заголовок. |
| description | OK | Описание заявки. |
| status_id | OK | FK на статус. |
| requester_id | OK | Инициатор (автор) заявки. |
| executor_id | OK | Исполнитель. |
| priority | OK | Приоритет (low/medium/high/critical). |
| due_at | OK | Срок выполнения. |
| closed_at | OK | Фактическое закрытие. |
| comment | Прим. | Один общий комментарий; для истории комментариев нужна отдельная таблица task_comments. |
| attachments_legacy | OK | Явно legacy (JSON) для миграции. |
| is_deleted, deleted_at, deleted_by, delete_reason | OK | Мягкое удаление и аудит удаления. |
| created_at, updated_at | OK | Временные метки. |

#### task_history
| Поле | Оценка | Комментарий |
|------|--------|-------------|
| task_id | OK | FK на заявку. |
| field_name | OK | Имя изменённого поля. |
| old_value, new_value | OK | Старое/новое значение (TEXT). |
| changed_by, changed_at | OK | Кто и когда. |
| comment | OK | Комментарий к изменению. |

#### task_equipment
| Поле | Оценка | Комментарий |
|------|--------|-------------|
| task_id, equipment_id | OK | Связь заявка–оборудование. |
| relation_type | OK | related / affected / requested_for. |
| is_primary | OK | Основной ли связанный актив. |
| linked_by, linked_at | OK | Кто и когда связал. |

#### desk_attachments
| Поле | Оценка | Комментарий |
|------|--------|-------------|
| id | OK | PK. |
| storage_path | OK | Путь к файлу в хранилище. |
| original_name | OK | Имя файла при загрузке. |
| file_extension | OK | Расширение. |
| mime_type | OK | MIME-тип. |
| size_bytes | OK | Размер в байтах. |
| checksum_sha256 | OK | Контрольная сумма. |
| uploaded_by, uploaded_at | OK | Кто и когда загрузил. |
| is_deleted, deleted_at, deleted_by | OK | Мягкое удаление. |

#### task_attachments
| Поле | Оценка | Комментарий |
|------|--------|-------------|
| task_id, attachment_id | OK | Связь заявка–файл (attachment_id → desk_attachments.id). |
| linked_by, linked_at | OK | Кто и когда привязал вложение к заявке. |

#### audit_events
| Поле | Оценка | Комментарий |
|------|--------|-------------|
| event_time | OK | Время события (соответствует ТЗ: дата/время). |
| actor_id | OK | Пользователь, выполнивший действие. |
| action_type | OK | Тип операции. |
| object_type, object_id | OK | Объект операции. |
| result_status | OK | success / error / denied. |
| source_ip | OK | IP-источник. |
| user_agent | OK | User-Agent запроса. |
| request_id, correlation_id | OK | Идентификаторы для трассировки. |
| payload | OK | Доп. данные (JSONB). |
| error_message | OK | Сообщение об ошибке при result_status = error. |

#### import_runs
| Поле | Оценка | Комментарий |
|------|--------|-------------|
| source_type, source_name | OK | Тип и имя источника. |
| started_at, finished_at | OK | Начало и окончание. |
| total_rows, success_rows, error_rows | OK | Счётчики протокола. |
| run_status | OK | running / success / error / partial. |
| initiated_by | OK | Кто запустил импорт. |
| details | OK | Доп. сведения (JSONB). |

#### import_errors
| Поле | Оценка | Комментарий |
|------|--------|-------------|
| import_run_id | OK | FK на сеанс импорта. |
| row_number | OK | Номер строки в источнике. |
| error_code, error_message | OK | Код и текст ошибки. |
| raw_payload | OK | Исходные данные строки (JSONB). |
| created_at | OK | Время фиксации ошибки. |

---

**Итог по полям:** все названия полей **корректны и понятны**. Стиль единообразный: суффикс _id для внешних ключей, _at для меток времени, is_ для флагов. Два поля отмечены как **Прим.**: `part_char_values.source` (желательно описать допустимые значения) и `tasks.comment` (одно поле на заявку; для полноценной истории комментариев — отдельная таблица).

### 3.3. Рекомендации по документации

- В словаре данных (или в комментариях к таблицам/полям в БД) явно описать: назначение `desk_attachments` vs `task_attachments`.
- Для справочников с префиксами dic_ и spr_ дать краткую расшифровку в общем описании модели (как в п. 3.1).
- После добавления software, licenses, software_installs и task_comments внести их в описание модели и ER-диаграмму в `docs/МОДЕЛЬ_БД_ias_uch_db_test.md`.

---

## 4. План действий по новой БД

### 4.1. Этап 1. Доработка DDL (схема под ТЗ)

| Шаг | Действие | Результат |
|-----|----------|-----------|
| 1.1 | Добавить в `scripts/create_ias_uch_db_test.sql` таблицы **software**, **licenses**, **software_installs** (по образцу ias_vnii_db с приведением к стилю БД: BIGSERIAL, FK на equipment/users). | Контур 5.1.12 обеспечен на уровне схемы. |
| 1.2 | Добавить таблицу **task_comments** (id, task_id, author_id, comment_text, created_at). | Выполнение требования 5.1.3.4. |
| 1.3 | По решению: добавить в **equipment** поля **brand**, **model** или зафиксировать в документации отказ. | Однозначность по атрибутам карточки актива (5.1.5.3). |
| 1.4 | Добавить триггеры updated_at для software, licenses (если в таблицах есть updated_at). | Согласованность с остальной схемой. |
| 1.5 | Обновить **docs/МОДЕЛЬ_БД_ias_uch_db_test.md**: новые таблицы, связи, ER. | Актуальная документация. |

### 4.2. Этап 2. Проверка и развёртывание БД

| Шаг | Действие | Результат |
|-----|----------|-----------|
| 2.1 | Создать БД: `CREATE DATABASE ias_uch_db_test WITH ENCODING 'UTF8' TEMPLATE template0;` | Чистая БД. |
| 2.2 | Выполнить полный скрипт `create_ias_uch_db_test.sql` (после внесения изменений этапа 1). | Создание всех объектов и базового наполнения справочников. |
| 2.3 | Проверить создание таблиц, ограничений, индексов, триггеров (вручную или тестовым скриптом). | Отсутствие ошибок DDL. |
| 2.4 | Создать первого пользователя-администратора и назначить ему роль «admin» (вручную или миграцией). | Возможность входа и администрирования. |

### 4.3. Этап 3. Подключение приложения и миграция данных

| Шаг | Действие | Результат |
|-----|----------|-----------|
| 3.1 | Настроить подключение приложения (PHP или иного) к БД **ias_uch_db_test** (например, через config/db.php или переменные окружения). | Приложение работает с новой схемой. |
| 3.2 | Адаптировать модели и запросы под новую схему: имена таблиц/полей (в т.ч. equipment.inventory_number, status_id, responsible_user_id; task_equipment; task_attachments; при добавлении — task_comments, software, licenses, software_installs). | Корректное чтение/запись. |
| 3.3 | При необходимости переноса данных из ias_uch_vnii (или ias_vnii_db): разработать и выполнить скрипты миграции с маппингом полей (arm→equipment, users, roles, tasks→task_attachments из JSON и т.д.). | Исторические данные в целевой БД. |
| 3.4 | Перенести связи вложений из tasks.attachments (JSON/text) в task_attachments и при необходимости в desk_attachments. | Нормализованная модель вложений. |

### 4.4. Этап 4. Эксплуатация и документирование

| Шаг | Действие | Результат |
|-----|----------|-----------|
| 4.1 | Зафиксировать в проектной документации: правила импорта (в т.ч. идемпотентность), перечень обязательных атрибутов заявки и карточки актива, ограничения на размер/количество вложений, разрешённые типы файлов для предпросмотра. | Соответствие ТЗ (обследование/настройка). |
| 4.2 | Настроить резервное копирование БД и вложений (файловое хранилище) по регламенту (ТЗ 5.3). | Надёжность и восстановление. |
| 4.3 | При добавлении контура ПО и лицензий: реализовать в приложении учёт ПО, лицензий и связей «актив — установленное ПО»; при необходимости — уведомления об истечении лицензий (ТЗ 5.1.12.3). | Полное закрытие контура 5.1.12. |

### 4.5. Порядок выполнения (сводка)

1. **Сначала:** доработка DDL (этап 1) и обновление документации модели.
2. **Затем:** развёртывание пустой БД и проверка (этап 2).
3. **Далее:** подключение приложения, адаптация кода, при необходимости миграция данных (этап 3).
4. **Постоянно:** регламенты, резервирование, при необходимости доработка контура ПО и лицензий (этап 4).

---

## 5. Итог

- Схема **ias_uch_db_test** в целом соответствует ТЗ и пригодна для развёрнутого проекта. Для полного соответствия ТЗ необходимо добавить контур учёта ПО и лицензий (таблицы software, licenses, software_installs) и таблицу комментариев к заявкам (task_comments).
- Состояние БД оценивается как хорошее: целостность, индексы, аудит и протоколы импорта реализованы; базовая загрузка справочников предусмотрена.
- Имена таблиц и полей корректны и понятны; рекомендуется зафиксировать в документации назначение пар таблиц desk_attachments / task_attachments и префиксов dic_ / spr_.
- План действий предусматривает четыре этапа: доработка DDL под ТЗ, развёртывание и проверка БД, подключение приложения и миграция данных, регламенты и эксплуатация. После выполнения этапов 1–2 БД может быть введена в работу; этапы 3–4 обеспечивают интеграцию с приложением и соответствие эксплуатационным требованиям ТЗ.
